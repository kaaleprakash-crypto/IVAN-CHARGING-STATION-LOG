<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Ivan Charging Station</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<style>
/* [Keep all your existing CSS styles exactly as they are] */
:root{--primary:#f1c40f;--success:#27ae60;--danger:#e74c3c;--info:#3498db;--purple:#9b59b6;--dark:#2c3e50;--light:#ecf0f1;--text:#333;--bg:#f8f9fa;--card-bg:#fff;--border:#ddd;--shadow:rgba(0,0,0,0.08)}
/* ... ALL YOUR EXISTING CSS REMAINS THE SAME ... */
</style>
</head>
<body>
<div class="container">
<div class="header"><h1>‚ö° Ivan Charging Station</h1>
<div class="top-left-controls no-print">
    <button id="contributorsBtn" class="btn btn-gold btn-sm">üèÜ Top 10</button>
</div>
<div class="top-controls no-print">
    <button id="darkModeBtn" class="btn btn-primary btn-sm">üåô Dark</button>
    <button id="csvBtn" class="btn btn-excel btn-sm">üìä CSV</button>
    <button id="reportBtn" class="btn btn-purple btn-sm">üìà Report</button>
    <button id="printBtn" class="btn btn-info btn-sm">üñ®Ô∏è Print</button>
    <button id="syncBtn" class="btn btn-success btn-sm">üîÑ Sync</button>
</div></div>
<div class="datetime-display"><div class="datetime-card"><div class="datetime-label">Date</div><div class="datetime-value" id="englishDateDisplay"></div></div>
<div class="datetime-card slogan"><div class="datetime-label">Slogan</div><div class="slogan-value">SKIP THE GAS, SHOW THE CLASS</div></div>
<div class="datetime-card"><div class="datetime-label">Time</div><div class="datetime-value" id="timeDisplay"></div></div></div>
<div class="summary-cards"><div class="summary-card charge"><div class="summary-label">CHARGE REVENUE</div><div class="summary-value"><span class="rs-symbol">Rs.</span> <span id="chargeTotal">0</span></div></div>
<div class="summary-card cafe"><div class="summary-label">CAFE REVENUE</div><div class="summary-value"><span class="rs-symbol">Rs.</span> <span id="cafeTotal">0</span></div></div>
<div class="summary-card total"><div class="summary-label">TOTAL REVENUE</div><div class="summary-value"><span class="rs-symbol">Rs.</span> <span id="allTotal">0</span></div></div>
<div class="summary-card due"><div class="summary-label">DUE</div><div class="summary-value due-value"><span class="rs-symbol">Rs.</span> <span id="dueTotal">0</span></div></div></div>
<div class="table-container"><table id="logbook"><thead><tr><th>S.N.</th><th>Time</th><th>Vehicle</th><th>% SOC</th><th>Diff</th><th>Amount</th><th>Cafe</th><th>Total</th><th>Paid</th><th>Status</th><th>Due</th><th></th></tr></thead><tbody></tbody></table></div>
<div class="floating-save-btn no-print"><button id="saveAllBtn" class="btn btn-success btn-sm">üíæ Save</button></div>
<div id="saveIndicator" class="save-indicator"><span>‚úì</span><span>Data Saved</span></div>
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div id="loadingText">Connecting to Cloud...</div>
</div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="report-modal no-print">
    <div class="report-content">
        <div class="report-header">
            <h2>üìä Revenue Report</h2>
            <button class="report-close" id="reportCloseBtn">√ó</button>
        </div>
        <div class="report-periods">
            <button class="btn btn-info report-period-btn" data-period="daily">Daily Report</button>
            <button class="btn btn-info report-period-btn" data-period="weekly">Weekly Report</button>
            <button class="btn btn-info report-period-btn" data-period="monthly">Monthly Report</button>
        </div>
        <div class="report-table-container">
            <table class="report-table" id="reportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>CHARGE REVENUE</th>
                        <th>CAFE REVENUE</th>
                        <th>TOTAL REVENUE</th>
                        <th>DUE</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <!-- Report data will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Top Contributors Modal -->
<div id="contributorsModal" class="contributors-modal no-print">
    <div class="contributors-content">
        <div class="contributors-header">
            <h2 id="contributorsTitle">üèÜ Top Contributors</h2>
            <button class="contributors-close" id="contributorsCloseBtn">√ó</button>
        </div>
        <div class="contributors-summary">
            <div class="contributors-summary-item">
                <div class="contributors-summary-label">Total Contributors</div>
                <div class="contributors-summary-value" id="totalContributors">0</div>
            </div>
            <div class="contributors-summary-item">
                <div class="contributors-summary-label">Total Transactions</div>
                <div class="contributors-summary-value" id="totalTransactions">0</div>
            </div>
            <div class="contributors-summary-item">
                <div class="contributors-summary-label">Month Revenue</div>
                <div class="contributors-summary-value" id="monthRevenue">Rs. 0</div>
            </div>
        </div>
        <div class="contributors-table-container">
            <table class="contributors-table" id="contributorsTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Vehicle</th>
                        <th>Total Amount</th>
                        <th>Transactions</th>
                        <th>Daily Average</th>
                    </tr>
                </thead>
                <tbody id="contributorsTableBody">
                    <!-- Contributors data will be inserted here -->
                </tbody>
            </table>
</div>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCmrCoi4PWj9yJBZyn91RSXXFO1JjknJ64",
  authDomain: "ivanchargingstation-165be.firebaseapp.com",
  projectId: "ivanchargingstation-165be",
  storageBucket: "ivanchargingstation-165be.firebasestorage.app",
  messagingSenderId: "1072613807112",
  appId: "1:1072613807112:web:4b6f6b189d28b170fbedbd",
  measurementId: "G-V2SM953CLH"
};

// Initialize Firebase
let db;
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  db = firebase.firestore();
  console.log("Firebase initialized successfully");
} catch (error) {
  console.error("Firebase initialization error:", error);
}

// Application State
let currentDate = getBusinessDayDate(); // Use business day (5:00 AM to 5:00 AM)
let isFirebaseConnected = false;
let nextDayTimer = null;
let vehicleDatabase = new Map();
let backgroundSaveTimer = null; // Timer for background saves
let lastSaveTime = null; // Track last save time

// Load vehicle database from saved data
function loadVehicleDatabase() {
  vehicleDatabase.clear();
  
  // Load from localStorage
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('logbook_')) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        data.forEach(entry => {
          if (entry.vehicle && entry.vehicle.trim()) {
            const vehicle = entry.vehicle.trim();
            const parts = vehicle.split(' ');
            if (parts.length >= 2) {
              const numbers = parts[parts.length - 1];
              if (/^\d{4}$/.test(numbers)) {
                vehicleDatabase.set(numbers, vehicle);
              }
            }
          }
        });
      } catch (error) {
        console.error("Error loading vehicle data from localStorage:", error);
      }
    }
  }
  
  // Also load from current table
  document.querySelectorAll("#logbook tbody tr .vehicle-input").forEach(input => {
    if (input.value && input.value.trim()) {
      const vehicle = input.value.trim();
      const parts = vehicle.split(' ');
      if (parts.length >= 2) {
        const numbers = parts[parts.length - 1];
        if (/^\d{4}$/.test(numbers)) {
          vehicleDatabase.set(numbers, vehicle);
        }
      }
    }
  });
  
  console.log("Vehicle database loaded:", vehicleDatabase.size, "vehicles");
}

// Find vehicle by exact 4-digit number match
function findVehicleByExactNumber(numberStr) {
  if (!numberStr || !/^\d{4}$/.test(numberStr)) return null;
  
  if (vehicleDatabase.has(numberStr)) {
    return vehicleDatabase.get(numberStr);
  }
  
  for (let [num, vehicle] of vehicleDatabase) {
    if (num === numberStr) {
      return vehicle;
    }
  }
  
  return null;
}

// Business day calculation (5:00 AM to next day 5:00 AM)
function getBusinessDayDate(date = new Date()) {
  const now = new Date(date);
  const currentHour = now.getHours();
  const currentMinute = now.getMinutes();
  
  if (currentHour < 5 || (currentHour === 5 && currentMinute < 0)) {
    now.setDate(now.getDate() - 1);
  }
  
  return now.toISOString().split('T')[0];
}

// Calculate next 5:00 AM
function getNext5AM() {
  const now = new Date();
  const next5AM = new Date(now);
  
  next5AM.setHours(5, 0, 0, 0);
  
  if (now.getHours() >= 5) {
    next5AM.setDate(next5AM.getDate() + 1);
  }
  
  return next5AM;
}

// Schedule daily reset at 5:00 AM
function scheduleDailyReset() {
  const next5AM = getNext5AM();
  const timeUntilNext5AM = next5AM.getTime() - Date.now();
  
  if (nextDayTimer) {
    clearTimeout(nextDayTimer);
  }
  
  nextDayTimer = setTimeout(() => {
    resetTableForNewDay();
    scheduleDailyReset();
  }, timeUntilNext5AM);
  
  console.log(`Next table reset scheduled at: ${next5AM.toString()}`);
}

// Reset table for new business day
async function resetTableForNewDay() {
  showNotification(`Business day ending. Saving data for ${currentDate}...`, "info");
  
  // Force save current day's data before clearing
  await saveToFirebase();
  
  document.querySelector("#logbook tbody").innerHTML = "";
  
  const oldDate = currentDate;
  currentDate = getBusinessDayDate();
  
  addRow();
  
  updateTotals();
  
  if (isFirebaseConnected) {
    await loadFromFirebase(currentDate);
  } else {
    loadFromLocalStorage();
  }
  
  showNotification(`New business day started (${currentDate}). Previous day (${oldDate}) data saved.`, "success");
  
  updateDateTimeDisplay();
}

// Date/Time Functions
const englishMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
const englishDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

function updateDateTimeDisplay() {
  const now = new Date();
  const day = englishDays[now.getDay()];
  const month = englishMonths[now.getMonth()];
  document.getElementById("englishDateDisplay").textContent = `${day}, ${now.getDate()} ${month} ${now.getFullYear()}`;
  document.getElementById("timeDisplay").textContent = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true});
}

// Utility Functions
function evaluateValue(value) {
  try {
    const result = Math.abs(eval(value) || 0);
    return isNaN(result) ? 0 : result;
  } catch {
    return 0;
  }
}

function showLoading(text = "Loading...") {
  const overlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');
  loadingText.textContent = text;
  overlay.style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

function showNotification(message, type = "success") {
  const notification = document.createElement("div");
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 15px;
    right: 15px;
    background: ${type === "success" ? "var(--success)" : "var(--danger)"};
    color: #fff;
    padding: 10px 18px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 3000;
    animation: slideIn 0.3s;
    font-size: 0.85rem
  `;
  document.body.appendChild(notification);
  setTimeout(() => {
    notification.style.animation = "slideOut 0.3s";
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Vehicle number formatting function
function formatVehicleNumber(value) {
  let formatted = value.replace(/\s/g, '').toUpperCase();
  
  const ev30Match = formatted.match(/^(EV30)(\d*)$/);
  const ev32Match = formatted.match(/^(EV32)(\d*)$/);
  
  if (ev30Match) {
    const vehicleName = ev30Match[1];
    const numbers = ev30Match[2];
    if (numbers) {
      return vehicleName + ' ' + numbers;
    }
    return vehicleName;
  }
  
  if (ev32Match) {
    const vehicleName = ev32Match[1];
    const numbers = ev32Match[2];
    if (numbers) {
      return vehicleName + ' ' + numbers;
    }
    return vehicleName;
  }
  
  const match = formatted.match(/^([A-Z]+)(\d*)$/);
  
  if (match) {
    const letters = match[1];
    const numbers = match[2];
    if (numbers) {
      return letters + ' ' + numbers;
    }
    return letters;
  }
  
  return formatted;
}

// Check if vehicle has 4 numbers and auto-switch to SOC field
function checkVehicleForAutoSwitch(vehicleInput, row) {
  const value = vehicleInput.value.trim();
  const parts = value.split(' ');
  
  if (parts.length === 2) {
    const numbers = parts[1];
    if (/^\d{4}$/.test(numbers)) {
      setTimeout(() => {
        const socInput = row.querySelector(".soc-input");
        if (socInput) {
          socInput.focus();
          socInput.setSelectionRange(0, 0);
        }
      }, 50);
      return true;
    }
  }
  
  return false;
}

// Check if SOC has number after hyphen greater than 10 or equals to 100, then auto-switch to Amount field
function checkSOCForAutoSwitch(socInput, row) {
  const value = socInput.value.trim();
  
  if (value.includes('-')) {
    const parts = value.split('-');
    
    if (parts.length === 2) {
      const afterHyphen = parts[1];
      const numbers = afterHyphen.match(/\d+/);
      if (numbers) {
        const numberAfterHyphen = parseInt(numbers[0]);
        
        if (!isNaN(numberAfterHyphen) && (numberAfterHyphen > 10 || numberAfterHyphen === 100)) {
          setTimeout(() => {
            const amountInput = row.querySelector(".amount-input");
            if (amountInput) {
              amountInput.focus();
              amountInput.setSelectionRange(0, 0);
            }
          }, 50);
          return true;
        }
      }
    }
  }
  
  return false;
}

// Data Table Functions
function shouldShowBlank(value) {
  if (value === "" || value === "0" || value === "0-") return true;
  try {
    return eval(value) === 0;
  } catch {
    return false;
  }
}

function isRowBlank(row) {
  const inputs = row.querySelectorAll("input");
  const paidButton = row.querySelector(".paid-button");
  const dueButton = row.querySelector(".due-button");
  const vehicle = inputs[1]?.value.trim();
  const amount = inputs[4]?.value.trim();
  const total = inputs[6]?.value.trim();
  const paid = inputs[7]?.value.trim();
  const hasStatus = (paidButton && paidButton.classList.contains("active")) || 
                   (dueButton && dueButton.classList.contains("active"));
  return !vehicle && !amount && !total && !paid && !hasStatus;
}

function isRowEmptyForExport(row) {
  const inputs = row.querySelectorAll("input");
  const soc = inputs[2]?.value.trim();
  const amount = evaluateValue(inputs[4]?.value || 0);
  const cafe = evaluateValue(inputs[5]?.value || 0);
  const total = evaluateValue(inputs[6]?.value || 0);
  
  return !soc && amount === 0 && cafe === 0 && total === 0;
}

function getFirstBlankRowBelow(currentRow) {
  const rows = document.querySelectorAll("#logbook tbody tr");
  const currentIndex = Array.from(rows).indexOf(currentRow);
  
  for (let i = currentIndex + 1; i < rows.length; i++) {
    if (isRowBlank(rows[i])) {
      return rows[i];
    }
  }
  return null;
}

function isRowAboveLocked(row) {
  const prevRow = row.previousElementSibling;
  return prevRow && prevRow.classList.contains("locked-row");
}

function updateSerialNumbers() {
  document.querySelectorAll("#logbook tbody tr").forEach((row, index) => {
    row.querySelector("td:first-child").textContent = index + 1;
  });
}

function moveToNextCell(currentInput, row) {
  const inputs = Array.from(row.querySelectorAll("input:not([readonly])")).filter(i => !i.classList.contains('time-input') && !i.classList.contains('diff-input'));
  const allElements = [...inputs];
  const currentIndex = allElements.indexOf(currentInput);
  
  if (currentIndex < allElements.length - 1) {
    allElements[currentIndex + 1].focus();
  } else {
    const blankRow = getFirstBlankRowBelow(row);
    if (blankRow) {
      const vehicleInput = blankRow.querySelector(".vehicle-input");
      if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
    }
  }
}

function lockRow(row) {
  const inputs = row.querySelectorAll("input:not(.time-input)");
  const buttons = row.querySelectorAll(".status-button");
  inputs.forEach(input => {
    input.setAttribute("readonly", "true");
  });
  buttons.forEach(button => {
    button.disabled = true;
  });
  row.classList.add("locked-row");
  autoSave();
}

function unlockRow(row) {
  const inputs = row.querySelectorAll("input:not(.time-input)");
  const buttons = row.querySelectorAll(".status-button");
  inputs.forEach(input => {
    input.removeAttribute("readonly");
  });
  buttons.forEach(button => {
    button.disabled = false;
  });
  row.classList.remove("locked-row");
  autoSave();
}

function calculateSOCDiff(socValue) {
  if (!socValue || !socValue.includes('-')) return '';
  const parts = socValue.split('-');
  if (parts.length === 2 && parts[0] && parts[1]) {
    const before = parseInt(parts[0]);
    const afterMatch = parts[1].match(/\d+/);
    if (afterMatch) {
      const after = parseInt(afterMatch[0]);
      if (!isNaN(before) && !isNaN(after) && after > before) {
        return (after - before).toString();
      }
    }
  }
  return '';
}

function formatSOCInput(value) {
  let x = value.replace(/[^a-zA-Z0-9\-]/g, '');
  return x;
}

async function deleteRow(row) {
  const rows = document.querySelectorAll("#logbook tbody tr");
  const isFirstRow = rows.length > 0 && row === rows[0];
  const isBlank = isRowBlank(row);
  
  if (!isFirstRow && isRowAboveLocked(row)) {
    showNotification("Cannot delete row: Row above is locked!", "danger");
    return;
  }
  
  if (!isBlank) {
    const rowType = isFirstRow ? "first row" : "row";
    if (!confirm(`This ${rowType} contains data. Are you sure you want to ${isFirstRow ? "clear" : "delete"} it?`)) {
      return;
    }
  }
  
  if (isFirstRow) {
    if (row.classList.contains("locked-row")) {
      unlockRow(row);
    }
    clearRowData(row);
    showNotification("First row data cleared (row preserved)");
  } else {
    row.remove();
    updateSerialNumbers();
    showNotification("Row deleted");
  }
  
  updateTotals();
  await autoSave(true);
}

function clearRowData(row) {
  const inputs = row.querySelectorAll("input");
  
  inputs.forEach(input => {
    if (!input.classList.contains('time-input')) {
      input.value = "";
      input.dispatchEvent(new Event('input'));
    } else {
      input.value = "";
    }
  });
  
  const paidButton = row.querySelector(".paid-button");
  const dueButton = row.querySelector(".due-button");
  if (paidButton && dueButton) {
    paidButton.style.display = "block";
    dueButton.style.display = "block";
    paidButton.classList.remove("active");
    dueButton.classList.remove("active");
  }
  
  unlockRow(row);
  row.classList.remove("due-row");
  updateTotals();
  
  const vehicleInput = row.querySelector(".vehicle-input");
  if (vehicleInput) {
    setTimeout(() => vehicleInput.focus(), 50);
  }
}

function checkAndAddRowIfNeeded(row, forceAdd = false) {
  const blankRow = getFirstBlankRowBelow(row);
  if (!blankRow || forceAdd) {
    const newRow = addRow();
    const vehicleInput = newRow.querySelector(".vehicle-input");
    if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
  } else {
    const vehicleInput = blankRow.querySelector(".vehicle-input");
    if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
  }
}

function setTimeOnVehicleEntry(vehicleInput, timeInput) {
  if (vehicleInput.value.trim() && !timeInput.value) {
    timeInput.value = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
    timeInput.dispatchEvent(new Event('input'));
  }
}

// Report Functions
function formatDateForDisplay(dateStr) {
  const parts = dateStr.split('-');
  if (parts.length === 3) {
    return `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return dateStr;
}

function showReportModal() {
  document.getElementById('reportModal').style.display = 'flex';
  loadDailyReport();
}

function hideReportModal() {
  document.getElementById('reportModal').style.display = 'none';
}

// Top Contributors Functions
function getCurrentMonthName() {
  const now = new Date();
  return englishMonths[now.getMonth()];
}

function showContributorsModal() {
  document.getElementById('contributorsModal').style.display = 'flex';
  const monthName = getCurrentMonthName();
  document.getElementById('contributorsTitle').textContent = `üèÜ Top Contributors - ${monthName}`;
  loadTopContributors();
}

function hideContributorsModal() {
  document.getElementById('contributorsModal').style.display = 'none';
}

function getMonthDates() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth();
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  
  const dates = [];
  const current = new Date(firstDay);
  
  while (current <= lastDay) {
    dates.push(getBusinessDayDate(new Date(current)));
    current.setDate(current.getDate() + 1);
  }
  
  return [...new Set(dates)];
}

function getLast7DaysDates() {
  const dates = [];
  const today = new Date();
  
  for (let i = 6; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    dates.push(getBusinessDayDate(date));
  }
  
  return [...new Set(dates)];
}

async function loadTopContributors() {
  const tbody = document.getElementById('contributorsTableBody');
  tbody.innerHTML = '<tr><td colspan="5" class="contributors-loading">Loading top contributors...</td></tr>';
  
  if (!db || !isFirebaseConnected) {
    tbody.innerHTML = '<tr><td colspan="5" class="contributors-no-data">Cloud connection required for top contributors</td></tr>';
    return;
  }
  
  try {
    const monthDates = getMonthDates();
    const promises = monthDates.map(date => db.collection("logbook").doc(date).get());
    const docs = await Promise.all(promises);
    
    const contributorsMap = new Map();
    let totalMonthRevenue = 0;
    let totalTransactions = 0;
    
    docs.forEach((doc, index) => {
      if (doc.exists) {
        const data = doc.data();
        const entries = data.entries || [];
        
        entries.forEach(entry => {
          const vehicle = entry.vehicle ? entry.vehicle.trim() : '';
          const chargeAmount = evaluateValue(entry.amount || 0);
          const cafeAmount = evaluateValue(entry.cafe || 0);
          const totalAmount = chargeAmount + cafeAmount;
          
          if (vehicle && totalAmount > 0) {
            totalTransactions++;
            totalMonthRevenue += totalAmount;
            
            if (!contributorsMap.has(vehicle)) {
              contributorsMap.set(vehicle, {
                totalAmount: 0,
                transactionCount: 0,
                chargeAmount: 0,
                cafeAmount: 0
              });
            }
            
            const contributor = contributorsMap.get(vehicle);
            contributor.totalAmount += totalAmount;
            contributor.chargeAmount += chargeAmount;
            contributor.cafeAmount += cafeAmount;
            contributor.transactionCount++;
          }
        });
      }
    });
    
    const contributorsArray = Array.from(contributorsMap, ([vehicle, data]) => ({
      vehicle,
      totalAmount: data.totalAmount,
      transactionCount: data.transactionCount,
      chargeAmount: data.chargeAmount,
      cafeAmount: data.cafeAmount,
      dailyAverage: data.transactionCount > 0 ? (data.totalAmount / data.transactionCount).toFixed(2) : 0
    }));
    
    contributorsArray.sort((a, b) => b.totalAmount - a.totalAmount);
    const topContributors = contributorsArray.slice(0, 10);
    
    document.getElementById('totalContributors').textContent = topContributors.length;
    document.getElementById('totalTransactions').textContent = totalTransactions;
    document.getElementById('monthRevenue').textContent = `Rs. ${totalMonthRevenue.toLocaleString()}`;
    
    tbody.innerHTML = '';
    
    if (topContributors.length > 0) {
      topContributors.forEach((contributor, index) => {
        const row = document.createElement('tr');
        
        if (index < 5) {
          row.className = 'top-contributor';
        }
        
        const rank = index + 1;
        const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
        
        row.innerHTML = `
          <td class="contributor-rank">${rankEmoji}</td>
          <td class="contributor-vehicle">${contributor.vehicle}</td>
          <td class="contributor-amount">Rs. ${contributor.totalAmount.toLocaleString()}</td>
          <td class="contributor-count">${contributor.transactionCount}</td>
          <td>Rs. ${parseFloat(contributor.dailyAverage).toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="contributors-no-data">No contributor data available for this month</td></tr>';
    }
  } catch (error) {
    console.error("Error loading top contributors:", error);
    tbody.innerHTML = '<tr><td colspan="5" class="contributors-no-data">Error loading top contributors</td></tr>';
  }
}

async function loadDailyReport() {
  const tbody = document.getElementById('reportTableBody');
  tbody.innerHTML = '<tr><td colspan="5" class="report-loading">Loading daily report...</td></tr>';
  
  if (!db || !isFirebaseConnected) {
    tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">Cloud connection required for reports</td></tr>';
    return;
  }
  
  try {
    const today = getBusinessDayDate();
    const docRef = db.collection("logbook").doc(today);
    const doc = await docRef.get();
    
    tbody.innerHTML = '';
    
    if (doc.exists) {
      const data = doc.data();
      const summary = data.summary || {};
      const charge = summary.charge ? parseInt(summary.charge.replace(/,/g, '')) || 0 : 0;
      const cafe = summary.cafe ? parseInt(summary.cafe.replace(/,/g, '')) || 0 : 0;
      const total = summary.total ? parseInt(summary.total.replace(/,/g, '')) || 0 : 0;
      const due = summary.due ? parseInt(summary.due.replace(/,/g, '')) || 0 : 0;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="report-date-cell">${formatDateForDisplay(today)}</td>
        <td>Rs. ${charge.toLocaleString()}</td>
        <td>Rs. ${cafe.toLocaleString()}</td>
        <td>Rs. ${total.toLocaleString()}</td>
        <td>Rs. ${due.toLocaleString()}</td>
      `;
      tbody.appendChild(row);
      
      const totalRow = document.createElement('tr');
      totalRow.className = 'report-total-row';
      totalRow.innerHTML = `
        <td><strong>TOTAL</strong></td>
        <td><strong>Rs. ${charge.toLocaleString()}</strong></td>
        <td><strong>Rs. ${cafe.toLocaleString()}</strong></td>
        <td><strong>Rs. ${total.toLocaleString()}</strong></td>
        <td><strong>Rs. ${due.toLocaleString()}</strong></td>
      `;
      tbody.appendChild(totalRow);
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">No data available for today</td></tr>';
    }
  } catch (error) {
    console.error("Error loading daily report:", error);
    tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">Error loading report</td></tr>';
  }
}

async function loadWeeklyReport() {
  const tbody = document.getElementById('reportTableBody');
  tbody.innerHTML = '<tr><td colspan="5" class="report-loading">Loading weekly report...</td></tr>';
  
  if (!db || !isFirebaseConnected) {
    tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">Cloud connection required for reports</td></tr>';
    return;
  }
  
  try {
    const weekDates = getLast7DaysDates();
    const promises = weekDates.map(date => db.collection("logbook").doc(date).get());
    const docs = await Promise.all(promises);
    
    tbody.innerHTML = '';
    let totalCharge = 0;
    let totalCafe = 0;
    let totalAll = 0;
    let totalDue = 0;
    let hasData = false;
    
    docs.forEach((doc, index) => {
      if (doc.exists) {
        hasData = true;
        const data = doc.data();
        const summary = data.summary || {};
        const charge = summary.charge ? parseInt(summary.charge.replace(/,/g, '')) || 0 : 0;
        const cafe = summary.cafe ? parseInt(summary.cafe.replace(/,/g, '')) || 0 : 0;
        const total = summary.total ? parseInt(summary.total.replace(/,/g, '')) || 0 : 0;
        const due = summary.due ? parseInt(summary.due.replace(/,/g, '')) || 0 : 0;
        
        totalCharge += charge;
        totalCafe += cafe;
        totalAll += total;
        totalDue += due;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="report-date-cell">${formatDateForDisplay(weekDates[index])}</td>
          <td>Rs. ${charge.toLocaleString()}</td>
          <td>Rs. ${cafe.toLocaleString()}</td>
          <td>Rs. ${total.toLocaleString()}</td>
          <td>Rs. ${due.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      }
    });
    
    if (hasData) {
      const totalRow = document.createElement('tr');
      totalRow.className = 'report-total-row';
      totalRow.innerHTML = `
        <td><strong>WEEKLY TOTAL</strong></td>
        <td><strong>Rs. ${totalCharge.toLocaleString()}</strong></td>
        <td><strong>Rs. ${totalCafe.toLocaleString()}</strong></td>
        <td><strong>Rs. ${totalAll.toLocaleString()}</strong></td>
        <td><strong>Rs. ${totalDue.toLocaleString()}</strong></td>
      `;
      tbody.appendChild(totalRow);
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">No data available for the last 7 days</td></tr>';
    }
  } catch (error) {
    console.error("Error loading weekly report:", error);
    tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">Error loading report</td></tr>';
  }
}

async function loadMonthlyReport() {
  const tbody = document.getElementById('reportTableBody');
  tbody.innerHTML = '<tr><td colspan="5" class="report-loading">Loading monthly report...</td></tr>';
  
  if (!db || !isFirebaseConnected) {
    tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">Cloud connection required for reports</td></tr>';
    return;
  }
  
  try {
    const monthDates = getMonthDates();
    const promises = monthDates.map(date => db.collection("logbook").doc(date).get());
    const docs = await Promise.all(promises);
    
    tbody.innerHTML = '';
    let totalCharge = 0;
    let totalCafe = 0;
    let totalAll = 0;
    let totalDue = 0;
    let hasData = false;
    
    docs.forEach((doc, index) => {
      if (doc.exists) {
        hasData = true;
        const data = doc.data();
        const summary = data.summary || {};
        const charge = summary.charge ? parseInt(summary.charge.replace(/,/g, '')) || 0 : 0;
        const cafe = summary.cafe ? parseInt(summary.cafe.replace(/,/g, '')) || 0 : 0;
        const total = summary.total ? parseInt(summary.total.replace(/,/g, '')) || 0 : 0;
        const due = summary.due ? parseInt(summary.due.replace(/,/g, '')) || 0 : 0;
        
        totalCharge += charge;
        totalCafe += cafe;
        totalAll += total;
        totalDue += due;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="report-date-cell">${formatDateForDisplay(monthDates[index])}</td>
          <td>Rs. ${charge.toLocaleString()}</td>
          <td>Rs. ${cafe.toLocaleString()}</td>
          <td>Rs. ${total.toLocaleString()}</td>
          <td>Rs. ${due.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      }
    });
    
    if (hasData) {
      const totalRow = document.createElement('tr');
      totalRow.className = 'report-total-row';
      totalRow.innerHTML = `
        <td><strong>MONTHLY TOTAL</strong></td>
        <td><strong>Rs. ${totalCharge.toLocaleString()}</strong></td>
        <td><strong>Rs. ${totalCafe.toLocaleString()}</strong></td>
        <td><strong>Rs. ${totalAll.toLocaleString()}</strong></td>
        <td><strong>Rs. ${totalDue.toLocaleString()}</strong></td>
      `;
      tbody.appendChild(totalRow);
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">No data available for this month</td></tr>';
    }
  } catch (error) {
    console.error("Error loading monthly report:", error);
    tbody.innerHTML = '<tr><td colspan="5" class="report-no-data">Error loading report</td></tr>';
  }
}

// CSV Export Function
function exportToCSV() {
  try {
    const rows = document.querySelectorAll("#logbook tbody tr");
    const filteredRows = Array.from(rows).filter(row => !isRowEmptyForExport(row));
    
    if (filteredRows.length === 0) {
      showNotification("No data to export", "danger");
      return;
    }
    
    const csvData = [];
    
    const headers = [
      "S.N.", "Time", "Vehicle", "% SOC", "Diff", 
      "Amount", "Cafe", "Total", "Paid", "Status", "Due"
    ];
    csvData.push(headers);
    
    filteredRows.forEach(row => {
      const inputs = row.querySelectorAll("input");
      const paidButton = row.querySelector(".paid-button");
      const dueButton = row.querySelector(".due-button");
      
      let status = "";
      if (paidButton.classList.contains("active")) {
        status = "Paid";
      } else if (dueButton.classList.contains("active")) {
        status = "Due";
      }
      
      const rowData = [
        row.querySelector("td:first-child").textContent,
        inputs[0]?.value || '',
        inputs[1]?.value || '',
        inputs[2]?.value || '',
        inputs[3]?.value || '',
        inputs[4]?.value || '',
        inputs[5]?.value || '',
        inputs[6]?.value || '',
        inputs[7]?.value || '',
        status,
        inputs[8]?.value || ''
      ];
      csvData.push(rowData);
    });
    
    csvData.push([]);
    csvData.push(["SUMMARY", "", "", "", "", "", "", "", "", "", ""]);
    
    csvData.push(["Charge Revenue", "", "", "", "", document.getElementById("chargeTotal").textContent, "", "", "", "", ""]);
    csvData.push(["Cafe Revenue", "", "", "", "", "", document.getElementById("cafeTotal").textContent, "", "", "", ""]);
    csvData.push(["Total Revenue", "", "", "", "", "", "", document.getElementById("allTotal").textContent, "", "", ""]);
    csvData.push(["Due Amount", "", "", "", "", "", "", "", "", "", document.getElementById("dueTotal").textContent]);
    
    csvData.push([]);
    csvData.push(["Export Date", new Date().toLocaleString(), "", "", "", "", "", "", "", "", ""]);
    csvData.push(["Business Day", currentDate, "", "", "", "", "", "", "", "", ""]);
    
    const csvString = csvData.map(row => 
      row.map(cell => {
        if (typeof cell === 'string' && (cell.includes(',') || cell.includes('"') || cell.includes('\n'))) {
          return '"' + cell.replace(/"/g, '""') + '"';
        }
        return cell;
      }).join(',')
    ).join('\n');
    
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    
    const filename = `charging_data_${currentDate}.csv`;
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification(`Data exported to ${filename}`, "success");
    
  } catch (error) {
    console.error("Error exporting to CSV:", error);
    showNotification("Error exporting to CSV", "danger");
  }
}

// NEW: Function to prepare table for printing (hides empty last rows)
function prepareForPrint() {
  const rows = document.querySelectorAll("#logbook tbody tr");
  
  rows.forEach(row => row.classList.remove('hide-in-print'));
  
  rows.forEach((row, index) => {
    if (isRowEmptyForExport(row)) {
      row.classList.add('hide-in-print');
    }
  });
}

// NEW: Custom print function
function printTable() {
  prepareForPrint();
  window.print();
  setTimeout(() => {
    const rows = document.querySelectorAll("#logbook tbody tr");
    rows.forEach(row => row.classList.remove('hide-in-print'));
  }, 1000);
}

function addRow(data = {}) {
  const tbody = document.querySelector("#logbook tbody");
  const row = document.createElement("tr");
  row.className = "fade-in";
  
  const isFirstRow = tbody.children.length === 0;
  
  const sn = document.createElement("td");
  sn.textContent = tbody.children.length + 1;
  
  const time = document.createElement("td");
  const timeInput = document.createElement("input");
  timeInput.value = data.time || "";
  timeInput.readOnly = true;
  timeInput.className = "time-input";
  time.appendChild(timeInput);
  
  const vehicle = document.createElement("td");
  vehicle.className = "vehicle-cell";
  
  const vehicleInput = document.createElement("input");
  vehicleInput.value = data.vehicle || "";
  vehicleInput.className = "vehicle-input";
  
  const suggestionsPopup = document.createElement("div");
  suggestionsPopup.className = "vehicle-suggestions-popup";
  document.body.appendChild(suggestionsPopup);
  
  function showSuggestions(searchText) {
    suggestionsPopup.innerHTML = '';
    
    if (!searchText || searchText.length < 3) {
      suggestionsPopup.style.display = 'none';
      return;
    }
    
    const numbers = searchText.match(/\d+/g);
    if (!numbers || numbers.join('').length < 3) {
      suggestionsPopup.style.display = 'none';
      return;
    }
    
    const suggestions = [];
    const searchNumberString = numbers.join('');
    
    for (let [num, vehicleName] of vehicleDatabase) {
      if (num.includes(searchNumberString)) {
        suggestions.push(vehicleName);
      }
    }
    
    if (suggestions.length === 0) {
      suggestionsPopup.style.display = 'none';
      return;
    }
    
    const limitedSuggestions = suggestions.slice(0, 5);
    
    limitedSuggestions.forEach(vehicle => {
      const suggestionItem = document.createElement("div");
      suggestionItem.className = "vehicle-suggestion-item";
      suggestionItem.textContent = vehicle;
      suggestionItem.addEventListener("click", function() {
        isAutoFilling = true;
        vehicleInput.value = vehicle;
        vehicleInput.dispatchEvent(new Event('input'));
        suggestionsPopup.style.display = 'none';
        
        setTimeout(() => {
          checkVehicleForAutoSwitch(vehicleInput, row);
        }, 50);
        
        if (vehicle.trim()) {
          const parts = vehicle.split(' ');
          if (parts.length >= 2) {
            const numbers = parts[parts.length - 1];
            if (/^\d{4}$/.test(numbers)) {
              vehicleDatabase.set(numbers, vehicle.trim());
            }
          }
        }
      });
      suggestionsPopup.appendChild(suggestionItem);
    });
    
    const rect = vehicleInput.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    const popupTop = rect.top + scrollTop - suggestionsPopup.offsetHeight - 5;
    const popupLeft = rect.left + scrollLeft + (rect.width / 2) - (suggestionsPopup.offsetWidth / 2);
    
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let finalLeft = popupLeft;
    let finalTop = popupTop;
    
    if (finalLeft < 10) finalLeft = 10;
    if (finalLeft + suggestionsPopup.offsetWidth > viewportWidth - 10) {
      finalLeft = viewportWidth - suggestionsPopup.offsetWidth - 10;
    }
    
    if (finalTop < 10) {
      finalTop = rect.top + scrollTop + rect.height + 5;
    }
    
    suggestionsPopup.style.top = finalTop + 'px';
    suggestionsPopup.style.left = finalLeft + 'px';
    suggestionsPopup.style.display = 'block';
  }
  
  let isAutoFilling = false;
  
  vehicleInput.addEventListener("input", function() {
    if (isAutoFilling) {
      isAutoFilling = false;
      return;
    }
    
    let value = this.value.toUpperCase();
    const cursorPos = this.selectionStart;
    this.value = value;
    this.setSelectionRange(cursorPos, cursorPos);
    
    if (this.value.trim() && !timeInput.value) {
      timeInput.value = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
      timeInput.dispatchEvent(new Event('input'));
    }
    
    const numbers = value.match(/\d+/g);
    if (numbers && numbers.join('').length >= 3) {
      showSuggestions(value);
    } else {
      suggestionsPopup.style.display = 'none';
    }
    
    checkVehicleForAutoSwitch(this, row);
  });
  
  vehicleInput.addEventListener("blur", function() {
    this.value = formatVehicleNumber(this.value);
    
    const value = this.value.trim();
    
    if (/^\d{4}$/.test(value)) {
      const matchedVehicle = findVehicleByExactNumber(value);
      if (matchedVehicle) {
        isAutoFilling = true;
        this.value = matchedVehicle;
        this.dispatchEvent(new Event('input'));
      }
    }
    
    const formattedValue = this.value.trim();
    if (formattedValue) {
      const parts = formattedValue.split(' ');
      if (parts.length >= 2) {
        const numbers = parts[parts.length - 1];
        if (/^\d{4}$/.test(numbers)) {
          vehicleDatabase.set(numbers, formattedValue);
        }
      }
    }
    
    setTimeOnVehicleEntry(this, timeInput);
    
    setTimeout(() => {
      suggestionsPopup.style.display = 'none';
    }, 200);
  });
  
  vehicleInput.addEventListener("focus", function() {
    const value = this.value;
    showSuggestions(value);
  });
  
  vehicleInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      this.value = formatVehicleNumber(this.value);
      
      const value = this.value.trim();
      
      if (/^\d{4}$/.test(value)) {
        const matchedVehicle = findVehicleByExactNumber(value);
        if (matchedVehicle) {
          isAutoFilling = true;
          this.value = matchedVehicle;
          this.dispatchEvent(new Event('input'));
        }
      }
      
      const formattedValue = this.value.trim();
      if (formattedValue) {
        const parts = formattedValue.split(' ');
        if (parts.length >= 2) {
          const numbers = parts[parts.length - 1];
          if (/^\d{4}$/.test(numbers)) {
            vehicleDatabase.set(numbers, formattedValue);
          }
        }
      }
      
      suggestionsPopup.style.display = 'none';
      
      if (!checkVehicleForAutoSwitch(vehicleInput, row)) {
        moveToNextCell(vehicleInput, row);
      }
    } else if (e.key === "Escape") {
      suggestionsPopup.style.display = 'none';
    }
  });
  
  vehicleInput.addEventListener("change", function() {
    if (!this.value.trim() && timeInput.value) {
      timeInput.value = "";
      timeInput.dispatchEvent(new Event('input'));
    }
  });
  
  vehicle.appendChild(vehicleInput);
  
  const originalRemoveChild = row.remove;
  row.remove = function() {
    if (suggestionsPopup && suggestionsPopup.parentNode) {
      suggestionsPopup.parentNode.removeChild(suggestionsPopup);
    }
    return originalRemoveChild.apply(this, arguments);
  };
  
  const soc = document.createElement("td");
  const socContainer = document.createElement("div");
  socContainer.className = "soc-container";
  const socInput = document.createElement("input");
  socInput.className = "soc-input";
  socInput.value = data.percent || "";
  
  let previousSOCValue = socInput.value;
  
  socInput.addEventListener("input", function() {
    let value = this.value;
    const cursorPos = this.selectionStart;
    value = value.replace(/[^0-9\-]/g, '');
    
    if (value.length === 2 && !value.includes('-') && previousSOCValue.length < 2) {
      value = value + '-';
    }
    
    if (previousSOCValue.length === 3 && previousSOCValue.includes('-') && 
        value.length === 2 && !value.includes('-')) {
      value = value;
    }
    
    this.value = value;
    previousSOCValue = value;
    
    if (cursorPos === 2 && value.length === 3 && value[2] === '-') {
      this.setSelectionRange(3, 3);
    } else if (cursorPos === 3 && previousSOCValue.length === 3 && 
               previousSOCValue.includes('-') && value.length === 2) {
      this.setSelectionRange(2, 2);
    } else {
      this.setSelectionRange(cursorPos, cursorPos);
    }
    
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateDiffColumn(this);
    
    checkSOCForAutoSwitch(this, row);
  });
  
  socInput.addEventListener("keydown", e => {
    if (e.key === "Backspace") {
      const cursorPos = this.selectionStart;
      const value = this.value;
      
      if (cursorPos === 3 && value.length === 3 && value[2] === '-') {
      }
    }
  });
  
  socInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      if (!checkSOCForAutoSwitch(socInput, row)) {
        moveToNextCell(socInput, row);
      }
    }
  });
  
  socInput.addEventListener("blur", function() {
    let value = this.value;
    
    if (value && !value.includes('-') && /^\d+$/.test(value)) {
      if (value.length <= 2) {
      } else if (value.length === 3) {
        value = value.substring(0, 2) + '-' + value.substring(2);
      } else if (value.length >= 4) {
        value = value.substring(0, 2) + '-' + value.substring(2);
      }
    }
    
    if (value.includes('-')) {
      const parts = value.split('-');
      if (parts[0]) {
        let num = parseInt(parts[0]);
        if (num > 100) {
          parts[0] = "100";
          value = parts[0] + (parts[1] ? '-' + parts[1] : '');
        }
      }
    }
    
    this.value = value;
    previousSOCValue = value;
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateDiffColumn(this);
  });
  
  shouldShowBlank(socInput.value) ? socInput.classList.add('empty-value') : socInput.classList.remove('empty-value');
  socContainer.appendChild(socInput);
  soc.appendChild(socContainer);
  
  const diff = document.createElement("td");
  const diffInput = document.createElement("input");
  diffInput.value = calculateSOCDiff(socInput.value) || "";
  diffInput.readOnly = true;
  diffInput.className = "diff-input";
  shouldShowBlank(diffInput.value) ? diffInput.classList.add('empty-value') : diffInput.classList.remove('empty-value');
  diff.appendChild(diffInput);
  
  const amount = document.createElement("td");
  const amountInput = document.createElement("input");
  amountInput.value = data.amount || "";
  amountInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateTotalFromAmount();
  });
  amountInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(amountInput, row);
  });
  shouldShowBlank(amountInput.value) ? amountInput.classList.add('empty-value') : amountInput.classList.remove('empty-value');
  amount.appendChild(amountInput);
  
  const cafe = document.createElement("td");
  const cafeInput = document.createElement("input");
  cafeInput.value = data.cafe || "";
  cafeInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateTotalFromCafe();
  });
  cafeInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(cafeInput, row);
  });
  shouldShowBlank(cafeInput.value) ? cafeInput.classList.add('empty-value') : cafeInput.classList.remove('empty-value');
  cafe.appendChild(cafeInput);
  
  const total = document.createElement("td");
  const totalInput = document.createElement("input");
  totalInput.value = data.total || "";
  totalInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateCafeFromTotal();
  });
  totalInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(totalInput, row);
  });
  shouldShowBlank(totalInput.value) ? totalInput.classList.add('empty-value') : totalInput.classList.remove('empty-value');
  total.appendChild(totalInput);
  
  const paid = document.createElement("td");
  const paidInput = document.createElement("input");
  paidInput.value = data.paid || "";
  
  let previousPaidValue = paidInput.value;
  
  paidInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    
    const totalVal = evaluateValue(totalInput.value);
    const paidVal = evaluateValue(this.value);
    
    if (totalVal > 0 && paidVal === totalVal) {
    }
    
    previousPaidValue = this.value;
    updateCalculations();
  });
  
  paidInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      const blankRow = getFirstBlankRowBelow(row);
      if (!blankRow) {
        const newRow = addRow();
        const vehicleInput = newRow.querySelector(".vehicle-input");
        if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
      } else {
        const vehicleInput = blankRow.querySelector(".vehicle-input");
        if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
      }
    }
  });
  
  paidInput.addEventListener("blur", function() {
    const totalVal = evaluateValue(totalInput.value);
    const paidVal = evaluateValue(paidInput.value);
    
    const paidButton = row.querySelector(".paid-button");
    if (totalVal > 0 && paidVal === totalVal && paidButton.classList.contains("active")) {
      const blankRow = getFirstBlankRowBelow(row);
      if (!blankRow) {
        setTimeout(() => {
          const newRow = addRow();
          const vehicleInput = newRow.querySelector(".vehicle-input");
          if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
        }, 100);
      }
    }
    
    updateCalculations();
  });
  
  shouldShowBlank(paidInput.value) ? paidInput.classList.add('empty-value') : paidInput.classList.remove('empty-value');
  paid.appendChild(paidInput);
  
  const status = document.createElement("td");
  const statusButtonsContainer = document.createElement("div");
  statusButtonsContainer.className = "status-buttons";
  
  const paidButton = document.createElement("button");
  paidButton.className = "status-button paid-button";
  paidButton.textContent = "Paid";
  paidButton.dataset.status = "paid";
  
  const dueButton = document.createElement("button");
  dueButton.className = "status-button due-button";
  dueButton.textContent = "Due";
  dueButton.dataset.status = "due";
  
  let isSingleButtonMode = false;
  
  if (data.status === "paid") {
    paidButton.classList.add("active");
    dueButton.style.display = "none";
    isSingleButtonMode = true;
  } else if (data.status === "due") {
    dueButton.classList.add("active");
    paidButton.style.display = "none";
    isSingleButtonMode = true;
    dueButton.title = "Double-click to change status";
  } else {
    paidButton.classList.remove("active");
    dueButton.classList.remove("active");
  }
  
  function showBothButtons() {
    paidButton.style.display = "block";
    dueButton.style.display = "block";
    paidButton.classList.remove("active");
    dueButton.classList.remove("active");
    isSingleButtonMode = false;
    unlockRow(row);
    dueButton.title = "";
  }
  
  function showSingleButton(selectedButton) {
    const totalVal = evaluateValue(totalInput.value);
    const paidVal = evaluateValue(paidInput.value);
    
    if (selectedButton === paidButton && totalVal > paidVal) {
      paidInput.value = totalInput.value;
      paidInput.dispatchEvent(new Event('input'));
      const newPaidVal = evaluateValue(paidInput.value);
      
      if (totalVal === newPaidVal) {
        paidButton.style.display = "block";
        paidButton.classList.add("active");
        dueButton.style.display = "none";
        dueButton.classList.remove("active");
        
        lockRow(row);
        
        if (totalVal === newPaidVal && totalVal > 0) {
          const blankRow = getFirstBlankRowBelow(row);
          if (!blankRow) {
            setTimeout(() => {
              const newRow = addRow();
              const vehicleInput = newRow.querySelector(".vehicle-input");
              if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
            }, 100);
          }
        }
        isSingleButtonMode = true;
        autoSave();
        return;
      }
    }
    
    if (selectedButton === dueButton && totalVal === paidVal && totalVal > 0) {
      showNotification("Cannot set to Due when Total = Paid", "danger");
      return;
    }
    
    if (selectedButton === paidButton && totalVal > paidVal) {
      showNotification("Cannot set to Paid when Total > Paid", "danger");
      return;
    }
    
    if (selectedButton === paidButton) {
      paidButton.style.display = "block";
      paidButton.classList.add("active");
      dueButton.style.display = "none";
      dueButton.classList.remove("active");
      
      if (!paidInput.value || paidInput.value === "0") {
        paidInput.value = totalInput.value;
        paidInput.dispatchEvent(new Event('input'));
      }
      
      lockRow(row);
      
      if (totalVal === paidVal && totalVal > 0) {
        const blankRow = getFirstBlankRowBelow(row);
        if (!blankRow) {
          setTimeout(() => {
            const newRow = addRow();
            const vehicleInput = newRow.querySelector(".vehicle-input");
            if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
          }, 100);
        }
      }
      isSingleButtonMode = true;
    } else {
      dueButton.style.display = "block";
      dueButton.classList.add("active");
      paidButton.style.display = "none";
      paidButton.classList.remove("active");
      
      unlockRow(row);
      dueButton.title = "Double-click to change status";
      isSingleButtonMode = true;
    }
    autoSave();
  }
  
  let dueButtonClickCount = 0;
  let dueButtonClickTimer = null;
  
  dueButton.addEventListener("click", function() {
    if (isSingleButtonMode && dueButton.classList.contains("active")) {
      dueButtonClickCount++;
      
      if (dueButtonClickCount === 1) {
        dueButtonClickTimer = setTimeout(() => {
          dueButtonClickCount = 0;
        }, 500);
        return;
      }
      
      clearTimeout(dueButtonClickTimer);
      dueButtonClickCount = 0;
    }
    
    if (isSingleButtonMode) {
      if (dueButton.classList.contains("active")) {
        showBothButtons();
      } else {
        showSingleButton(dueButton);
      }
    } else {
      showSingleButton(dueButton);
    }
  });
  
  paidButton.addEventListener("click", function() {
    if (isSingleButtonMode) {
      if (paidButton.classList.contains("active")) {
        showBothButtons();
      } else {
        showSingleButton(paidButton);
      }
    } else {
      showSingleButton(paidButton);
    }
  });
  
  statusButtonsContainer.appendChild(paidButton);
  statusButtonsContainer.appendChild(dueButton);
  status.appendChild(statusButtonsContainer);
  
  const due = document.createElement("td");
  const dueInput = document.createElement("input");
  dueInput.value = data.due || "";
  dueInput.readOnly = true;
  dueInput.className = "due-input";
  shouldShowBlank(dueInput.value) ? dueInput.classList.add('empty-value') : dueInput.classList.remove('empty-value');
  due.appendChild(dueInput);
  
  const deleteCol = document.createElement("td");
  const deleteButton = document.createElement("button");
  deleteButton.className = "delete-button no-print";
  deleteButton.textContent = "√ó";
  
  if (isFirstRow) {
    deleteButton.title = "Clear first row data (cannot delete first row)";
  } else {
    deleteButton.title = "Delete this row (from table and cloud)";
  }
  
  deleteButton.addEventListener("click", async function() {
    await deleteRow(row);
  });
  deleteCol.appendChild(deleteButton);
  
  row.addEventListener("dblclick", function() {
    if (this.classList.contains("locked-row")) {
      if (confirm("Do you want to unlock and edit this row?")) {
        unlockRow(this);
        showBothButtons();
        showNotification("Row unlocked for editing", "info");
        const paidInput = this.querySelector('td:nth-child(9) input');
        if (paidInput) {
          setTimeout(() => paidInput.focus(), 50);
        }
      }
    }
  });
  
  function updateTotalFromAmount() {
    const amountVal = evaluateValue(amountInput.value);
    const cafeVal = evaluateValue(cafeInput.value);
    const totalVal = amountVal + cafeVal;
    
    totalInput.value = totalVal || "";
    shouldShowBlank(totalInput.value) ? totalInput.classList.add('empty-value') : totalInput.classList.remove('empty-value');
    updateCalculations();
  }
  
  function updateTotalFromCafe() {
    const amountVal = evaluateValue(amountInput.value);
    const cafeVal = evaluateValue(cafeInput.value);
    const totalVal = amountVal + cafeVal;
    
    totalInput.value = totalVal || "";
    shouldShowBlank(totalInput.value) ? totalInput.classList.add('empty-value') : totalInput.classList.remove('empty-value');
    updateCalculations();
  }
  
  function updateCafeFromTotal() {
    const amountVal = evaluateValue(amountInput.value);
    const totalVal = evaluateValue(totalInput.value);
    const cafeVal = totalVal - amountVal;
    
    cafeInput.value = Math.max(0, cafeVal) || "";
    shouldShowBlank(cafeInput.value) ? cafeInput.classList.add('empty-value') : cafeInput.classList.remove('empty-value');
    updateCalculations();
  }
  
  function updateCalculations() {
    const totalVal = evaluateValue(totalInput.value);
    const paidVal = evaluateValue(paidInput.value);
    const dueVal = totalVal - paidVal;
    
    const dueAmount = Math.max(0, dueVal);
    dueInput.value = dueAmount || "";
    dueInput.className = "due-input";
    
    if (dueVal > 0) {
      row.classList.add("due-row");
      dueInput.classList.remove('empty-value');
      if (isSingleButtonMode && paidButton.classList.contains("active")) {
        showBothButtons();
      }
      if (!isSingleButtonMode || (isSingleButtonMode && !dueButton.classList.contains("active"))) {
        showSingleButton(dueButton);
      }
    } else {
      row.classList.remove("due-row");
      dueInput.classList.remove('empty-value');
      shouldShowBlank(dueInput.value) ? dueInput.classList.add('empty-value') : dueInput.classList.remove('empty-value');
    }
    
    shouldShowBlank(cafeInput.value) ? cafeInput.classList.add('empty-value') : cafeInput.classList.remove('empty-value');
    
    if (totalVal > 0) {
      if (paidVal >= totalVal) {
        if (!isSingleButtonMode || (isSingleButtonMode && !paidButton.classList.contains("active"))) {
          showSingleButton(paidButton);
        }
        row.classList.remove("due-row");
      }
    }
    
    updateTotals();
    autoSave();
  }
  
  function updateDiffColumn(socInputElement) {
    const diffValue = calculateSOCDiff(socInputElement.value);
    diffInput.value = diffValue || "";
    if (diffValue) {
      diffInput.classList.remove('empty-value');
    } else {
      diffInput.classList.add('empty-value');
    }
  }
  
  [amountInput, cafeInput, totalInput].forEach(input => {
    input.addEventListener("input", function() {
      if (input === amountInput) {
        updateTotalFromAmount();
      } else if (input === cafeInput) {
        updateTotalFromCafe();
      } else if (input === totalInput) {
        updateCafeFromTotal();
      }
    });
  });
  
  paidInput.addEventListener("input", function() {
    updateCalculations();
  });
  
  row.append(sn, time, vehicle, soc, diff, amount, cafe, total, paid, status, due, deleteCol);
  tbody.appendChild(row);
  
  if (!data.vehicle) {
    setTimeout(() => vehicleInput.focus(), 50);
  }
  
  if (data.total && !data.cafe) {
    updateCafeFromTotal();
  } else if (data.cafe && !data.total) {
    updateTotalFromCafe();
  } else if (data.amount && (!data.total || !data.cafe)) {
    updateTotalFromAmount();
  } else {
    updateCalculations();
  }
  
  if (data.vehicle && data.vehicle.trim()) {
    const vehicleStr = data.vehicle.trim();
    const parts = vehicleStr.split(' ');
    if (parts.length >= 2) {
      const numbers = parts[parts.length - 1];
      if (/^\d{4}$/.test(numbers)) {
        vehicleDatabase.set(numbers, vehicleStr);
      }
    }
  }
  
  autoSave();
  tbody.parentElement.scrollTop = tbody.parentElement.scrollHeight;
  
  if (data.status === "paid") {
    lockRow(row);
  }
  
  if (data.due && parseFloat(data.due) > 0) {
    row.classList.add("due-row");
  }
  
  return row;
}

function getDataForSave() {
  const rows = document.querySelectorAll("#logbook tbody tr");
  const data = Array.from(rows).map(row => {
    const inputs = row.querySelectorAll("input");
    const paidButton = row.querySelector(".paid-button");
    const dueButton = row.querySelector(".due-button");
    
    let status = "";
    if (paidButton.classList.contains("active")) {
      status = "paid";
    } else if (dueButton.classList.contains("active")) {
      status = "due";
    }
    
    return {
      time: inputs[0]?.value || '',
      vehicle: inputs[1]?.value || '',
      percent: inputs[2]?.value || '',
      diff: inputs[3]?.value || '',
      amount: inputs[4]?.value || '',
      cafe: inputs[5]?.value || '',
      total: inputs[6]?.value || '',
      paid: inputs[7]?.value || '',
      status: status,
      due: inputs[8]?.value || ''
    };
  });
  return data;
}

function updateTotals() {
  let charge = 0, cafe = 0, all = 0, due = 0;
  document.querySelectorAll("#logbook tbody tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    charge += evaluateValue(inputs[4]?.value || 0);
    cafe += evaluateValue(inputs[5]?.value || 0);
    all += evaluateValue(inputs[6]?.value || 0);
    due += evaluateValue(inputs[8]?.value || 0);
  });
  
  document.getElementById("chargeTotal").textContent = charge.toLocaleString();
  document.getElementById("cafeTotal").textContent = cafe.toLocaleString();
  document.getElementById("allTotal").textContent = all.toLocaleString();
  document.getElementById("dueTotal").textContent = due.toLocaleString();
}

// ========== FIXED FIREBASE FUNCTIONS ==========

async function saveToFirebase() {
  if (!db) {
    console.log("Firebase not initialized");
    return false;
  }

  try {
    const data = getDataForSave();
    const summary = {
      charge: document.getElementById("chargeTotal").textContent,
      cafe: document.getElementById("cafeTotal").textContent,
      total: document.getElementById("allTotal").textContent,
      due: document.getElementById("dueTotal").textContent,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      lastUpdated: new Date().toISOString()
    };

    console.log("Saving to Firebase for date:", currentDate);
    console.log("Data to save:", data);
    console.log("Summary:", summary);

    await db.collection("logbook").doc(currentDate).set({
      entries: data,
      summary: summary,
      date: currentDate,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    console.log("Successfully saved to Firebase");
    lastSaveTime = new Date();
    return true;
  } catch (error) {
    console.error("Error saving to Firebase:", error);
    return false;
  }
}

async function loadFromFirebase(date = currentDate) {
  if (!db) {
    loadFromLocalStorage();
    return;
  }

  try {
    const docRef = db.collection("logbook").doc(date);
    const doc = await docRef.get();
    
    if (doc.exists) {
      const data = doc.data();
      const entries = data.entries || [];
      
      document.querySelector("#logbook tbody").innerHTML = "";
      
      if (entries.length > 0) {
        entries.forEach(row => addRow(row));
      } else {
        addRow();
      }
      
      updateTotals();
      console.log("Loaded data from Firebase for date:", date);
    } else {
      if (document.querySelectorAll("#logbook tbody tr").length === 0) {
        addRow();
      }
      console.log("No data found in Firebase for date:", date);
    }
  } catch (error) {
    console.error("Error loading from Firebase:", error);
    loadFromLocalStorage();
  }
}

function loadFromLocalStorage() {
  const data = localStorage.getItem(`logbook_${currentDate}`);
  if (data) {
    try {
      const entries = JSON.parse(data);
      document.querySelector("#logbook tbody").innerHTML = "";
      if (entries.length > 0) {
        entries.forEach(row => addRow(row));
      } else {
        addRow();
      }
      updateTotals();
    } catch (error) {
      console.error("Error loading from local storage:", error);
      addRow();
    }
  } else {
    addRow();
  }
}

// ========== FIXED AUTO-SAVE FUNCTION ==========
// Now saves to Firebase every time (when connected) and includes 1-minute background sync

async function autoSave(forceCloudSave = false) {
  const data = getDataForSave();
  
  // Save to local storage with date key
  localStorage.setItem(`logbook_${currentDate}`, JSON.stringify(data));
  
  // Update vehicle database
  data.forEach(entry => {
    if (entry.vehicle && entry.vehicle.trim()) {
      const vehicle = entry.vehicle.trim();
      const parts = vehicle.split(' ');
      if (parts.length >= 2) {
        const numbers = parts[parts.length - 1];
        if (/^\d{4}$/.test(numbers)) {
          vehicleDatabase.set(numbers, vehicle);
        }
      }
    }
  });
  
  // Show save indicator (briefly)
  const indicator = document.getElementById("saveIndicator");
  indicator.classList.add("visible");
  setTimeout(() => indicator.classList.remove("visible"), 1500);
  
  // ========== FIX: Always try to save to Firebase when connected ==========
  if (db && isFirebaseConnected) {
    try {
      await saveToFirebase();
      console.log("Auto-saved to Firebase");
    } catch (error) {
      console.error("Auto-save to Firebase failed:", error);
    }
  }
}

// ========== NEW: Background sync function ==========
async function backgroundSync() {
  if (!db || !isFirebaseConnected) {
    console.log("Background sync: Firebase not connected");
    return;
  }
  
  try {
    const data = getDataForSave();
    if (data.length === 0 || (data.length === 1 && isRowBlank(document.querySelector("#logbook tbody tr")))) {
      console.log("Background sync: No data to save");
      return;
    }
    
    console.log("Background sync: Saving to Firebase...");
    await saveToFirebase();
    console.log("Background sync: Completed successfully");
  } catch (error) {
    console.error("Background sync error:", error);
  }
}

// ========== NEW: Setup background sync interval ==========
function setupBackgroundSync() {
  // Clear any existing timer
  if (backgroundSaveTimer) {
    clearInterval(backgroundSaveTimer);
  }
  
  // Set up 1-minute background sync (60000 milliseconds)
  backgroundSaveTimer = setInterval(async () => {
    console.log("Running 1-minute background sync...");
    await backgroundSync();
  }, 60000); // 1 minute = 60000 milliseconds
  
  console.log("Background sync set up: will save to Firebase every 1 minute");
}

// Mobile Chrome optimizations
function setupMobileOptimizations() {
  const inputs = document.querySelectorAll('input, select, textarea');
  inputs.forEach(input => {
    input.addEventListener('focus', () => {
      const style = window.getComputedStyle(input);
      if (parseFloat(style.fontSize) < 16) {
        input.style.fontSize = '16px';
      }
    });
    
    input.addEventListener('blur', () => {
      input.style.fontSize = '';
    });
  });
  
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });
  
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });
}

// Initialize the application
window.onload = async function() {
  // Initialize date/time
  updateDateTimeDisplay();
  setInterval(updateDateTimeDisplay, 1000);
  
  // Setup daily reset timer
  scheduleDailyReset();
  
  // Load vehicle database
  loadVehicleDatabase();
  
  // Check Firebase connection
  if (db) {
    try {
      showLoading("Connecting to Cloud...");
      await db.collection("test").doc("test").get();
      isFirebaseConnected = true;
      hideLoading();
      console.log("Firebase connection successful");
      showNotification("Connected to Cloud", "success");
    } catch (error) {
      hideLoading();
      console.log("Firebase test failed, using local storage:", error);
      isFirebaseConnected = false;
      showNotification("Cloud not connected. Using local storage.", "info");
    }
  }
  
  // Load data for current business day
  if (isFirebaseConnected) {
    await loadFromFirebase(currentDate);
  } else {
    loadFromLocalStorage();
  }
  
  // Set up dark mode
  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark-mode");
    document.getElementById("darkModeBtn").textContent = "‚òÄÔ∏è Light";
  }
  
  // Event listeners
  document.getElementById("darkModeBtn").addEventListener("click", function() {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    this.textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
    localStorage.setItem("darkMode", isDark);
  });
  
  document.getElementById("csvBtn").addEventListener("click", exportToCSV);
  
  document.getElementById("contributorsBtn").addEventListener("click", showContributorsModal);
  
  document.getElementById("contributorsCloseBtn").addEventListener("click", hideContributorsModal);
  
  document.getElementById("contributorsModal").addEventListener("click", function(e) {
    if (e.target === this) {
      hideContributorsModal();
    }
  });
  
  document.getElementById("reportBtn").addEventListener("click", showReportModal);
  
  document.getElementById("reportCloseBtn").addEventListener("click", hideReportModal);
  
  document.getElementById("reportModal").addEventListener("click", function(e) {
    if (e.target === this) {
      hideReportModal();
    }
  });
  
  document.querySelectorAll(".report-period-btn").forEach(btn => {
    btn.addEventListener("click", function() {
      const period = this.getAttribute("data-period");
      if (period === "daily") {
        loadDailyReport();
      } else if (period === "weekly") {
        loadWeeklyReport();
      } else if (period === "monthly") {
        loadMonthlyReport();
      }
    });
  });
  
  document.getElementById("printBtn").addEventListener("click", printTable);
  
  document.getElementById("syncBtn").addEventListener("click", async function() {
    if (isFirebaseConnected) {
      showLoading("Syncing with Cloud...");
      try {
        const success = await saveToFirebase();
        hideLoading();
        if (success) {
          this.innerHTML = "‚úì Synced";
          setTimeout(() => this.innerHTML = "üîÑ Sync", 2000);
          showNotification("Data synced to Cloud successfully!");
        } else {
          showNotification("Failed to sync with Cloud", "danger");
        }
      } catch (error) {
        hideLoading();
        showNotification("Error syncing with Cloud", "danger");
      }
    } else {
      showNotification("Firebase not connected.", "danger");
    }
  });
  
  document.getElementById("saveAllBtn").addEventListener("click", async function() {
    if (isFirebaseConnected) {
      showLoading("Saving to Cloud...");
      try {
        const success = await saveToFirebase();
        hideLoading();
        if (success) {
          showNotification("Data saved to Cloud successfully!");
        } else {
          showNotification("Failed to save to Cloud", "danger");
        }
      } catch (error) {
        hideLoading();
        showNotification("Error saving to Cloud", "danger");
      }
    } else {
      autoSave();
      showNotification("Saved to local storage (Cloud not connected)", "info");
    }
  });
  
  // Setup mobile optimizations
  setupMobileOptimizations();
  
  // ========== SETUP BACKGROUND SYNC ==========
  if (isFirebaseConnected) {
    setupBackgroundSync();
  }
  
  // Auto-save every 30 seconds to local storage (for safety)
  setInterval(() => {
    const data = getDataForSave();
    localStorage.setItem(`logbook_${currentDate}`, JSON.stringify(data));
  }, 30000);
  
  updateTotals();
};

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    if (document.querySelectorAll("#logbook tbody tr").length === 0) {
      addRow();
    }
  });
}
</script>
</body>
</html>
