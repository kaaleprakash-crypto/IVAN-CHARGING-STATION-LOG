<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ivan Charging Station</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<!-- PDF Export Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
:root{--primary:#f1c40f;--success:#27ae60;--danger:#e74c3c;--info:#3498db;--purple:#9b59b6;--dark:#2c3e50;--light:#ecf0f1;--text:#333;--bg:#f8f9fa;--card-bg:#fff;--border:#ddd;--shadow:rgba(0,0,0,0.08)}
.dark-mode{--primary:#f39c12;--success:#2ecc71;--danger:#e74c3c;--info:#2980b9;--purple:#8e44ad;--dark:#1a252f;--light:#34495e;--text:#ecf0f1;--bg:#2c3e50;--card-bg:#34495e;--border:#4a6278;--shadow:rgba(0,0,0,0.2)}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI','Roboto',sans-serif;background:var(--bg);color:var(--text);line-height:1.4;padding:10px;min-height:100vh;font-size:13px;transition:all 0.3s}
.container{max-width:1400px;margin:0 auto}
.header{text-align:center;margin-bottom:10px;position:relative}
.header h1{font-size:1.6rem;color:var(--dark);margin-bottom:6px;background:linear-gradient(45deg,var(--success),var(--info));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:900}
.top-controls{position:absolute;top:0;right:0;display:flex;gap:6px;z-index:1000}
.datetime-display{display:flex;justify-content:center;gap:12px;margin-bottom:15px;flex-wrap:wrap}
.datetime-card{background:var(--card-bg);padding:12px;border-radius:10px;box-shadow:0 4px 12px var(--shadow);flex:1;min-width:160px;text-align:center;border-left:4px solid var(--info);transition:transform 0.2s}
.datetime-card:hover{transform:translateY(-3px);box-shadow:0 6px 16px var(--shadow)}
.datetime-card.slogan{border-left-color:var(--success);background:linear-gradient(135deg,var(--card-bg) 0%,rgba(39,174,96,0.08) 100%)}
.datetime-label{font-size:0.75rem;font-weight:900;color:var(--info);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.datetime-value{font-size:1rem;font-weight:900;color:var(--text);text-shadow:0 1px 2px rgba(0,0,0,0.1)}
.slogan-value{color:var(--success);font-size:0.95rem;font-weight:900;text-shadow:0 1px 2px rgba(0,0,0,0.1)}
.btn{padding:6px 12px;border:none;border-radius:6px;font-weight:600;font-size:0.8rem;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:5px;text-transform:uppercase;letter-spacing:0.2px;box-shadow:0 2px 4px var(--shadow)}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px var(--shadow)}
.btn-primary{background:linear-gradient(45deg,var(--primary),#e67e22);color:#000}
.btn-success{background:linear-gradient(45deg,var(--success),#2ecc71);color:#fff}
.btn-danger{background:linear-gradient(45deg,var(--danger),#c0392b);color:#fff}
.btn-info{background:linear-gradient(45deg,var(--info),#2980b9);color:#fff}
.btn-purple{background:linear-gradient(45deg,var(--purple),#8e44ad);color:#fff}
.btn-sm{padding:5px 10px;font-size:0.75rem}
.floating-save-btn{position:fixed;bottom:20px;right:20px;z-index:1000;animation:float 3s ease-in-out infinite;box-shadow:0 4px 12px rgba(39,174,96,0.3)}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.floating-save-btn .btn{padding:8px 16px;font-size:0.85rem;font-weight:700;border-radius:8px}
.main-controls{display:flex;justify-content:flex-start;gap:8px;margin:10px 0;flex-wrap:wrap}
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin:15px 0}
.summary-card{background:var(--card-bg);padding:15px;border-radius:10px;box-shadow:0 4px 12px var(--shadow);text-align:center;position:relative;overflow:hidden;transition:transform 0.2s}
.summary-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(45deg,var(--primary),var(--success))}
.summary-card.charge::before,.summary-card.cafe::before,.summary-card.total::before{background:linear-gradient(45deg,var(--info),#2980b9)!important}
.summary-card.due::before{background:linear-gradient(45deg,#f39c12,#d35400)}
.summary-card:hover{transform:translateY(-3px)}
.summary-label{font-size:0.8rem;font-weight:800;color:var(--info);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.summary-value{font-size:1.4rem;font-weight:800;color:var(--dark)}
.dark-mode .summary-value{color:var(--light)}
.rs-symbol{font-size:1rem;color:var(--success);font-weight:700;margin-right:3px}
.summary-value.due-value{color:var(--danger)}
.table-container{background:var(--card-bg);border-radius:10px;box-shadow:0 4px 16px var(--shadow);padding:10px;margin:15px 0;overflow:hidden;max-height:50vh;overflow-y:auto;border:1px solid var(--border)}
.table-container::-webkit-scrollbar{width:6px}
.table-container::-webkit-scrollbar-track{background:var(--bg);border-radius:3px}
.table-container::-webkit-scrollbar-thumb{background:var(--primary);border-radius:3px}
.table-container::-webkit-scrollbar-thumb:hover{background:#e67e22}
table{width:100%;border-collapse:collapse;min-width:950px}
thead{position:sticky;top:0;z-index:10}
th{background:linear-gradient(45deg,var(--dark),var(--info));color:#fff;padding:8px 6px;text-align:center;font-weight:600;font-size:0.78rem;text-transform:uppercase;letter-spacing:0.3px;border:1px solid rgba(255,255,255,0.2)}
th::after{content:'';position:absolute;bottom:0;left:0;width:100%;height:2px;background:var(--primary)}
td{padding:6px;text-align:center;border:1px solid var(--border);font-size:0.82rem;height:38px;vertical-align:middle}
tr{transition:all 0.2s}
tr:hover{background:rgba(52,152,219,0.08)!important}
tr.locked-row{background:rgba(39,174,96,0.05)!important}
tr.locked-row:hover{background:rgba(39,174,96,0.08)!important}
/* Light red background for rows with due amounts */
tr.due-row{background:rgba(231,76,60,0.1)!important}
tr.due-row:hover{background:rgba(231,76,60,0.15)!important}
.dark-mode tr.due-row{background:rgba(231,76,60,0.2)!important}
.dark-mode tr.due-row:hover{background:rgba(231,76,60,0.25)!important}
tr:nth-child(even){background:rgba(0,0,0,0.02)}
.dark-mode tr:nth-child(even){background:rgba(255,255,255,0.04)}
/* Override for even rows with due */
tr.due-row:nth-child(even){background:rgba(231,76,60,0.15)!important}
.dark-mode tr.due-row:nth-child(even){background:rgba(231,76,60,0.25)!important}
/* Adjusted column widths with new Diff column */
th:nth-child(1),td:nth-child(1){width:50px}
th:nth-child(2),td:nth-child(2){width:70px}
th:nth-child(3),td:nth-child(3){width:110px}
th:nth-child(4),td:nth-child(4){width:80px} /* % SOC */
th:nth-child(5),td:nth-child(5){width:60px} /* Diff column */
th:nth-child(6),td:nth-child(6){width:80px} /* Amount */
th:nth-child(7),td:nth-child(7){width:75px} /* Cafe */
th:nth-child(8),td:nth-child(8){width:65px} /* Total */
th:nth-child(9),td:nth-child(9){width:75px} /* Paid */
th:nth-child(10),td:nth-child(10){width:75px} /* Status */
th:nth-child(11),td:nth-child(11){width:80px} /* Due - Make this column bold red font */
th:nth-child(12),td:nth-child(12){width:30px;padding:2px}
input{width:100%;padding:4px 6px;border:1.5px solid var(--border);border-radius:4px;background:var(--card-bg);color:var(--text);font-size:0.82rem;transition:all 0.2s;height:26px;display:block;box-sizing:border-box;text-align:center}
input:not([readonly]){cursor:text;caret-color:var(--primary)}
.vehicle-input{text-transform:uppercase}
input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(241,196,15,0.15)}
input[readonly]{background:var(--bg);opacity:0.8;cursor:default}
td input{border:1.5px solid var(--border)!important;background:var(--card-bg)!important;color:var(--text)!important;font-weight:500}
input.empty-value{color:transparent!important}
.diff-input{font-weight:700;color:var(--success)!important;background:rgba(39,174,96,0.1)!important}
.dark-mode .diff-input{background:rgba(39,174,96,0.2)!important}
/* Make ALL due values bold red */
.due-input{color:#ff0000!important;font-weight:900!important;font-size:0.95rem!important;text-shadow:0 1px 3px rgba(255,0,0,0.4)!important}
.dark-mode .due-input{color:#ff6b6b!important}
/* Style for zero due values - show as blank */
.due-input.empty-value{color:transparent!important;text-shadow:none!important}
.status-select{width:100%;padding:4px 6px;border:1.5px solid var(--border);border-radius:4px;background:var(--card-bg);color:var(--text);font-size:0.82rem;transition:all 0.2s;height:26px;text-align:center;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right 6px center;background-size:12px;padding-right:20px}
.status-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(241,196,15,0.15)}
.status-select:disabled{opacity:0.7;cursor:default}
/* Hide dropdown arrow when status is selected */
.status-select[value="paid"],
.status-select[value="due"],
.status-select.status-paid,
.status-select.status-due {
    background-image: none;
}
.status-paid{color:var(--success)!important;font-weight:700!important}
.status-due{color:#ff0000!important;font-weight:700!important}
.save-indicator{position:fixed;bottom:70px;right:20px;background:linear-gradient(45deg,var(--success),#2ecc71);color:#fff;padding:8px 14px;border-radius:6px;box-shadow:0 4px 12px rgba(39,174,96,0.3);opacity:0;transition:all 0.2s;font-weight:600;display:flex;align-items:center;gap:6px;z-index:1000;transform:translateX(80px);font-size:0.8rem}
.save-indicator.visible{opacity:1;transform:translateX(0)}
.delete-btn{background:#e74c3c;color:white;border:none;border-radius:3px;padding:2px 6px;cursor:pointer;font-size:0.7rem;transition:all 0.2s;width:100%;height:22px;display:flex;align-items:center;justify-content:center;min-width:28px;opacity:0}
tr:hover .delete-btn{opacity:1}
.delete-btn:hover{background:#c0392b;transform:scale(1.05)}
.delete-btn:disabled{background:#95a5a6;cursor:not-allowed;opacity:0}
.soc-container{position:relative;width:100%}
.soc-input{width:100%}
.action-cell{min-width:30px;padding:2px!important}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:2000;color:white;font-size:1.2rem;flex-direction:column;gap:15px}
.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.report-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;justify-content:center;align-items:center}
.report-content{background:var(--card-bg);padding:20px;border-radius:10px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
.report-options{display:flex;flex-direction:column;gap:10px;margin-top:15px}
.report-option-btn{width:100%;padding:12px;text-align:center}
@media (max-width:768px){body{padding:8px;font-size:12px}.header h1{font-size:1.4rem}.datetime-display{flex-direction:column;align-items:center;gap:8px}.datetime-card{width:100%;min-width:unset;padding:10px}.summary-cards{grid-template-columns:repeat(2,1fr);gap:10px}.table-container{padding:8px;max-height:40vh}.top-controls{position:relative;top:0;right:0;justify-content:center;margin-bottom:10px}.btn{padding:5px 10px;font-size:0.75rem}.summary-value{font-size:1.3rem}th,td{padding:5px 4px}.floating-save-btn{bottom:15px;right:15px}.floating-save-btn .btn{padding:6px 14px;font-size:0.8rem}.main-controls{justify-content:center}}
@media (max-width:480px){.summary-cards{grid-template-columns:1fr}.btn{padding:4px 8px;font-size:0.7rem}.summary-value{font-size:1.2rem}th,td{padding:4px 3px;font-size:0.75rem}.floating-save-btn{bottom:10px;right:10px}.floating-save-btn .btn{padding:5px 12px;font-size:0.75rem}}
/* Print styles - FIXED */
@media print{
    @page {
        margin: 0.5in;
        size: A4 portrait;
    }
    body {
        background: white !important;
        color: black !important;
        padding: 0 !important;
        font-size: 12pt !important;
        margin: 0 !important;
    }
    .container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    .no-print {
        display: none !important;
    }
    /* Header for print */
    .header {
        text-align: center !important;
        margin-bottom: 20px !important;
        page-break-after: avoid !important;
    }
    .header h1 {
        font-size: 24pt !important;
        color: black !important;
        background: none !important;
        -webkit-text-fill-color: black !important;
        margin-bottom: 10px !important;
    }
    /* Date display for print */
    .datetime-display {
        display: flex !important;
        justify-content: center !important;
        gap: 20px !important;
        margin: 20px 0 !important;
        page-break-inside: avoid !important;
    }
    .datetime-card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
        background: white !important;
    }
    .datetime-value, .slogan-value {
        color: black !important;
        font-weight: bold !important;
    }
    /* Summary cards for print - REMOVED no-print class from HTML */
    .summary-cards {
        display: flex !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 15px !important;
        margin: 20px 0 !important;
        page-break-inside: avoid !important;
    }
    .summary-card {
        flex: 1 !important;
        min-width: 180px !important;
        max-width: 220px !important;
        page-break-inside: avoid !important;
        border: 1px solid #000 !important;
        box-shadow: none !important;
        background: white !important;
        padding: 10px !important;
    }
    .summary-card::before {
        display: none !important;
    }
    .summary-label {
        color: black !important;
        font-size: 9pt !important;
        font-weight: bold !important;
    }
    .summary-value {
        color: black !important;
        font-size: 14pt !important;
        font-weight: bold !important;
    }
    .summary-value.due-value {
        color: #c0392b !important;
    }
    .rs-symbol {
        color: black !important;
    }
    /* Table container for print */
    .table-container {
        box-shadow: none !important;
        border: 1px solid #000 !important;
        max-height: none !important;
        overflow: visible !important;
        padding: 5px !important;
        background: white !important;
        page-break-inside: auto !important;
    }
    /* Table for print */
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        page-break-inside: auto !important;
    }
    th {
        background: #333 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        font-size: 8pt !important;
        padding: 6px 4px !important;
        border: 1px solid #000 !important;
    }
    td {
        border: 1px solid #000 !important;
        font-size: 8pt !important;
        padding: 4px !important;
        color: black !important;
    }
    tr {
        page-break-inside: avoid !important;
        page-break-after: auto !important;
    }
    tr:nth-child(even) {
        background: #f5f5f5 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    /* Input fields in print */
    td input {
        background: white !important;
        color: black !important;
        border: none !important;
        text-align: center !important;
    }
    input.empty-value {
        color: transparent !important;
    }
    .due-input {
        color: #c0392b !important;
        font-weight: bold !important;
    }
    /* Remove all animations and transitions */
    * {
        animation: none !important;
        transition: none !important;
    }
    /* Page break control */
    .page-break {
        page-break-before: always;
    }
}
@keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn 0.3s ease forwards}
</style>
</head>
<body>
<div class="container">
<div class="header"><h1>‚ö° Ivan Charging Station</h1>
<div class="top-controls no-print">
    <button id="darkModeBtn" class="btn btn-primary btn-sm">üåô Dark</button>
    <button id="printBtn" class="btn btn-info btn-sm">üñ®Ô∏è Print</button>
    <button id="reportBtn" class="btn btn-purple btn-sm">üìä Report</button>
    <button id="syncBtn" class="btn btn-success btn-sm">üîÑ Sync</button>
</div></div>
<div class="datetime-display"><div class="datetime-card"><div class="datetime-label">Date</div><div class="datetime-value" id="englishDateDisplay"></div></div>
<div class="datetime-card slogan"><div class="datetime-label">Slogan</div><div class="slogan-value">SKIP THE GAS, SHOW THE CLASS</div></div>
<div class="datetime-card"><div class="datetime-label">Time</div><div class="datetime-value" id="timeDisplay"></div></div></div>
<div class="main-controls no-print">
    <button id="clearAllBtn" class="btn btn-danger btn-sm">üóëÔ∏è Clear All</button>
    <button id="loadFromCloudBtn" class="btn btn-info btn-sm">‚òÅÔ∏è Load Cloud</button>
</div>
<!-- REMOVED no-print class from summary-cards -->
<div class="summary-cards"><div class="summary-card charge"><div class="summary-label">CHARGE REVENUE</div><div class="summary-value"><span class="rs-symbol">Rs.</span> <span id="chargeTotal">0</span></div></div>
<div class="summary-card cafe"><div class="summary-label">CAFE REVENUE</div><div class="summary-value"><span class="rs-symbol">Rs.</span> <span id="cafeTotal">0</span></div></div>
<div class="summary-card total"><div class="summary-label">TOTAL REVENUE</div><div class="summary-value"><span class="rs-symbol">Rs.</span> <span id="allTotal">0</span></div></div>
<div class="summary-card due"><div class="summary-label">DUE</div><div class="summary-value due-value"><span class="rs-symbol">Rs.</span> <span id="dueTotal">0</span></div></div></div>
<div class="table-container"><table id="logbook"><thead><tr><th>S.N.</th><th>Time</th><th>Vehicle</th><th>% SOC</th><th>Diff</th><th>Amount</th><th>Cafe</th><th>Total</th><th>Paid</th><th>Status</th><th>Due</th><th></th></tr></thead><tbody></tbody></table></div>
<div class="floating-save-btn no-print"><button id="saveAllBtn" class="btn btn-success btn-sm">üíæ Save to Cloud</button></div>
<div id="saveIndicator" class="save-indicator"><span>‚úì</span><span>Data Saved</span></div>

<!-- Report Modal -->
<div id="reportModal" class="report-modal">
    <div class="report-content">
        <h2 style="text-align:center;margin-bottom:20px;color:var(--dark)">üìä Generate Report</h2>
        <div class="report-options">
            <button id="dailyReportBtn" class="btn btn-success report-option-btn">üìÖ Daily Report</button>
            <button id="weeklyReportBtn" class="btn btn-info report-option-btn">üìÜ Weekly Report</button>
            <button id="monthlyReportBtn" class="btn btn-purple report-option-btn">üìà Monthly Report</button>
            <button id="customReportBtn" class="btn btn-primary report-option-btn">üìã Custom Report</button>
            <button id="exportCSVBtn" class="btn btn-success report-option-btn">üìÑ Export as CSV</button>
            <button id="exportPDFBtn" class="btn btn-danger report-option-btn">üìë Export as PDF</button>
            <button id="closeReportBtn" class="btn btn-danger report-option-btn">‚ùå Close</button>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div id="loadingText">Connecting to Cloud...</div>
</div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyCmrCoi4PWj9yJBZyn91RSXXFO1JjknJ64",
  authDomain: "ivanchargingstation-165be.firebaseapp.com",
  projectId: "ivanchargingstation-165be",
  storageBucket: "ivanchargingstation-165be.firebasestorage.app",
  messagingSenderId: "1072613807112",
  appId: "1:1072613807112:web:4b6f6b189d28b170fbedbd",
  measurementId: "G-V2SM953CLH"
};

// Initialize Firebase
let db;
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  db = firebase.firestore();
  console.log("Firebase initialized successfully");
} catch (error) {
  console.error("Firebase initialization error:", error);
  // Silent error - don't show notification
}

// Initialize jsPDF
const { jsPDF } = window.jspdf;

// Application State
let currentDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
let isFirebaseConnected = false;

// Date/Time Functions
const englishMonths = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
const englishDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

function updateDateTime() {
  const now = new Date();
  const day = englishDays[now.getDay()];
  const month = englishMonths[now.getMonth()];
  document.getElementById("englishDateDisplay").textContent = `${day}, ${now.getDate()} ${month} ${now.getFullYear()}`;
  document.getElementById("timeDisplay").textContent = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true});
  
  // Update current date
  currentDate = now.toISOString().split('T')[0];
}

// Utility Functions
function evaluateValue(value) {
  try {
    const result = Math.abs(eval(value) || 0);
    return isNaN(result) ? 0 : result;
  } catch {
    return 0;
  }
}

function showLoading(text = "Loading...") {
  const overlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');
  loadingText.textContent = text;
  overlay.style.display = 'flex';
}

function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

function showNotification(message, type = "success") {
  const notification = document.createElement("div");
  notification.textContent = message;
  notification.style.cssText = `
    position: fixed;
    top: 15px;
    right: 15px;
    background: ${type === "success" ? "var(--success)" : "var(--danger)"};
    color: #fff;
    padding: 10px 18px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 3000;
    animation: slideIn 0.3s;
    font-size: 0.85rem
  `;
  document.body.appendChild(notification);
  setTimeout(() => {
    notification.style.animation = "slideOut 0.3s";
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Report Functions
function generateDailyReport() {
  const reportWindow = window.open('', '_blank');
  
  // Get current summary values
  const charge = document.getElementById("chargeTotal").textContent;
  const cafe = document.getElementById("cafeTotal").textContent;
  const total = document.getElementById("allTotal").textContent;
  const due = document.getElementById("dueTotal").textContent;
  const date = document.getElementById("englishDateDisplay").textContent;
  
  // Get table data
  const rows = document.querySelectorAll("#logbook tbody tr");
  
  let html = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Daily Report - Ivan Charging Station</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                background: white;
                color: black;
            }
            h1, h2 { 
                color: #333; 
                text-align: center; 
            }
            .report-header { 
                text-align: center; 
                margin-bottom: 30px; 
                border-bottom: 2px solid #333; 
                padding-bottom: 15px; 
            }
            .summary-container { 
                display: flex; 
                justify-content: center; 
                gap: 20px; 
                margin: 20px 0; 
                flex-wrap: wrap; 
            }
            .summary-box { 
                padding: 15px; 
                border-radius: 8px; 
                text-align: center; 
                min-width: 200px;
                border: 2px solid;
            }
            .charge-box { 
                background: #e3f2fd; 
                border-color: #2196f3; 
            }
            .cafe-box { 
                background: #e8f5e9; 
                border-color: #4caf50; 
            }
            .total-box { 
                background: #fff3e0; 
                border-color: #ff9800; 
            }
            .due-box { 
                background: #ffebee; 
                border-color: #f44336; 
            }
            table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 20px 0; 
            }
            th { 
                background: #333; 
                color: white; 
                padding: 10px; 
                text-align: center; 
            }
            td { 
                padding: 8px; 
                border: 1px solid #ddd; 
                text-align: center; 
            }
            tr:nth-child(even) { 
                background: #f5f5f5; 
            }
            .footer { 
                text-align: center; 
                margin-top: 30px; 
                color: #666; 
            }
            @media print { 
                .no-print { display: none; }
                .print-btn { display: none; }
                body { margin: 0.5in; }
            }
        </style>
    </head>
    <body>
        <div class="report-header">
            <h1>‚ö° Ivan Charging Station</h1>
            <h2>Daily Report - ${date}</h2>
        </div>
        
        <div class="summary-container">
            <div class="summary-box charge-box">
                <h3>CHARGE REVENUE</h3>
                <h2>Rs. ${charge}</h2>
            </div>
            <div class="summary-box cafe-box">
                <h3>CAFE REVENUE</h3>
                <h2>Rs. ${cafe}</h2>
            </div>
            <div class="summary-box total-box">
                <h3>TOTAL REVENUE</h3>
                <h2>Rs. ${total}</h2>
            </div>
            <div class="summary-box due-box">
                <h3>DUE AMOUNT</h3>
                <h2>Rs. ${due}</h2>
            </div>
        </div>
        
        <h3>Transaction Details</h3>
        <table>
            <thead>
                <tr>
                    <th>S.N.</th><th>Time</th><th>Vehicle</th><th>% SOC</th><th>Diff</th>
                    <th>Amount</th><th>Cafe</th><th>Total</th><th>Paid</th><th>Status</th><th>Due</th>
                </tr>
            </thead>
            <tbody>
  `;
  
  rows.forEach((row, index) => {
    const inputs = row.querySelectorAll("input");
    const select = row.querySelector("select");
    const status = select?.value || '';
    
    html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${inputs[0]?.value || ''}</td>
                    <td>${inputs[1]?.value || ''}</td>
                    <td>${inputs[2]?.value || ''}</td>
                    <td>${inputs[3]?.value || ''}</td>
                    <td>${inputs[4]?.value || ''}</td>
                    <td>${inputs[5]?.value || ''}</td>
                    <td>${inputs[6]?.value || ''}</td>
                    <td>${inputs[7]?.value || ''}</td>
                    <td>${status}</td>
                    <td>${inputs[8]?.value || ''}</td>
                </tr>
    `;
  });
  
  html += `
            </tbody>
        </table>
        
        <div class="footer">
            <p>Generated on: ${new Date().toLocaleString()}</p>
            <p><strong>SKIP THE GAS, SHOW THE CLASS</strong></p>
            <button class="print-btn" onclick="window.print()" style="padding:10px 20px;margin:20px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;">üñ®Ô∏è Print Report</button>
        </div>
    </body>
    </html>
  `;
  
  reportWindow.document.write(html);
  reportWindow.document.close();
}

function generateWeeklyReport() {
  showLoading("Generating Weekly Report...");
  
  if (!db) {
    hideLoading();
    showNotification("Firebase not connected. Weekly reports require cloud data.", "danger");
    return;
  }
  
  try {
    // Calculate date range for last 7 days
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 6); // Last 7 days including today
    
    const dateRange = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      dateRange.push(d.toISOString().split('T')[0]);
    }
    
    // Fetch data for each day
    const promises = dateRange.map(date => db.collection("logbook").doc(date).get());
    
    Promise.all(promises).then(docs => {
      let weeklyData = [];
      let weeklyCharge = 0;
      let weeklyCafe = 0;
      let weeklyTotal = 0;
      let weeklyDue = 0;
      
      docs.forEach((doc, index) => {
        if (doc.exists) {
          const data = doc.data();
          const dateStr = dateRange[index];
          const date = new Date(dateStr);
          const formattedDate = `${date.getDate()} ${englishMonths[date.getMonth()].substring(0,3)}`;
          
          weeklyData.push({
            date: formattedDate,
            charge: data.summary?.charge?.replace(/,/g, '') || '0',
            cafe: data.summary?.cafe?.replace(/,/g, '') || '0',
            total: data.summary?.total?.replace(/,/g, '') || '0',
            due: data.summary?.due?.replace(/,/g, '') || '0'
          });
          
          weeklyCharge += parseFloat(data.summary?.charge?.replace(/,/g, '') || 0);
          weeklyCafe += parseFloat(data.summary?.cafe?.replace(/,/g, '') || 0);
          weeklyTotal += parseFloat(data.summary?.total?.replace(/,/g, '') || 0);
          weeklyDue += parseFloat(data.summary?.due?.replace(/,/g, '') || 0);
        }
      });
      
      hideLoading();
      
      // Create weekly report window
      const reportWindow = window.open('', '_blank');
      let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Weekly Report - Ivan Charging Station</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1, h2 { color: #333; text-align: center; }
                .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                .summary-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
                .summary-box { padding: 15px; border-radius: 8px; text-align: center; min-width: 200px; border: 2px solid; }
                .charge-box { background: #e3f2fd; border-color: #2196f3; }
                .cafe-box { background: #e8f5e9; border-color: #4caf50; }
                .total-box { background: #fff3e0; border-color: #ff9800; }
                .due-box { background: #ffebee; border-color: #f44336; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th { background: #333; color: white; padding: 10px; text-align: center; }
                td { padding: 8px; border: 1px solid #ddd; text-align: center; }
                tr:nth-child(even) { background: #f5f5f5; }
                .footer { text-align: center; margin-top: 30px; color: #666; }
                @media print { .no-print { display: none; } .print-btn { display: none; } body { margin: 0.5in; } }
            </style>
        </head>
        <body>
            <div class="report-header">
                <h1>‚ö° Ivan Charging Station</h1>
                <h2>Weekly Report - ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}</h2>
            </div>
            
            <div class="summary-container">
                <div class="summary-box charge-box">
                    <h3>TOTAL CHARGE REVENUE</h3>
                    <h2>Rs. ${weeklyCharge.toLocaleString()}</h2>
                </div>
                <div class="summary-box cafe-box">
                    <h3>TOTAL CAFE REVENUE</h3>
                    <h2>Rs. ${weeklyCafe.toLocaleString()}</h2>
                </div>
                <div class="summary-box total-box">
                    <h3>TOTAL REVENUE</h3>
                    <h2>Rs. ${weeklyTotal.toLocaleString()}</h2>
                </div>
                <div class="summary-box due-box">
                    <h3>TOTAL DUE</h3>
                    <h2>Rs. ${weeklyDue.toLocaleString()}</h2>
                </div>
            </div>
            
            <h3>Daily Breakdown</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th><th>Charge Revenue</th><th>Cafe Revenue</th><th>Total Revenue</th><th>Due Amount</th>
                    </tr>
                </thead>
                <tbody>
      `;
      
      weeklyData.forEach(day => {
        html += `
                    <tr>
                        <td>${day.date}</td>
                        <td>Rs. ${parseFloat(day.charge).toLocaleString()}</td>
                        <td>Rs. ${parseFloat(day.cafe).toLocaleString()}</td>
                        <td>Rs. ${parseFloat(day.total).toLocaleString()}</td>
                        <td>Rs. ${parseFloat(day.due).toLocaleString()}</td>
                    </tr>
        `;
      });
      
      html += `
                </tbody>
            </table>
            
            <div class="footer">
                <p>Generated on: ${new Date().toLocaleString()}</p>
                <p><strong>SKIP THE GAS, SHOW THE CLASS</strong></p>
                <button class="print-btn" onclick="window.print()" style="padding:10px 20px;margin:20px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;">üñ®Ô∏è Print Report</button>
            </div>
        </body>
        </html>
      `;
      
      reportWindow.document.write(html);
      reportWindow.document.close();
      showNotification("Weekly report generated!");
      
    }).catch(error => {
      hideLoading();
      console.error("Error generating weekly report:", error);
      showNotification("Error generating weekly report", "danger");
    });
    
  } catch (error) {
    hideLoading();
    console.error("Error:", error);
    showNotification("Error generating weekly report", "danger");
  }
}

function generateMonthlyReport() {
  showLoading("Generating Monthly Report...");
  
  if (!db) {
    hideLoading();
    showNotification("Firebase not connected. Monthly reports require cloud data.", "danger");
    return;
  }
  
  try {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    const dateRange = [];
    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
      dateRange.push(d.toISOString().split('T')[0]);
    }
    
    const promises = dateRange.map(date => db.collection("logbook").doc(date).get());
    
    Promise.all(promises).then(docs => {
      let monthlyData = [];
      let monthlyCharge = 0;
      let monthlyCafe = 0;
      let monthlyTotal = 0;
      let monthlyDue = 0;
      
      docs.forEach((doc, index) => {
        if (doc.exists) {
          const data = doc.data();
          const dateStr = dateRange[index];
          const date = new Date(dateStr);
          const formattedDate = `${date.getDate()} ${englishMonths[date.getMonth()].substring(0,3)}`;
          
          monthlyData.push({
            date: formattedDate,
            charge: data.summary?.charge?.replace(/,/g, '') || '0',
            cafe: data.summary?.cafe?.replace(/,/g, '') || '0',
            total: data.summary?.total?.replace(/,/g, '') || '0',
            due: data.summary?.due?.replace(/,/g, '') || '0'
          });
          
          monthlyCharge += parseFloat(data.summary?.charge?.replace(/,/g, '') || 0);
          monthlyCafe += parseFloat(data.summary?.cafe?.replace(/,/g, '') || 0);
          monthlyTotal += parseFloat(data.summary?.total?.replace(/,/g, '') || 0);
          monthlyDue += parseFloat(data.summary?.due?.replace(/,/g, '') || 0);
        }
      });
      
      hideLoading();
      
      const reportWindow = window.open('', '_blank');
      let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Monthly Report - Ivan Charging Station</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1, h2 { color: #333; text-align: center; }
                .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                .summary-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
                .summary-box { padding: 15px; border-radius: 8px; text-align: center; min-width: 200px; border: 2px solid; }
                .charge-box { background: #e3f2fd; border-color: #2196f3; }
                .cafe-box { background: #e8f5e9; border-color: #4caf50; }
                .total-box { background: #fff3e0; border-color: #ff9800; }
                .due-box { background: #ffebee; border-color: #f44336; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th { background: #333; color: white; padding: 10px; text-align: center; }
                td { padding: 8px; border: 1px solid #ddd; text-align: center; }
                tr:nth-child(even) { background: #f5f5f5; }
                .footer { text-align: center; margin-top: 30px; color: #666; }
                @media print { .no-print { display: none; } .print-btn { display: none; } body { margin: 0.5in; } }
            </style>
        </head>
        <body>
            <div class="report-header">
                <h1>‚ö° Ivan Charging Station</h1>
                <h2>Monthly Report - ${englishMonths[today.getMonth()]} ${today.getFullYear()}</h2>
            </div>
            
            <div class="summary-container">
                <div class="summary-box charge-box">
                    <h3>TOTAL CHARGE REVENUE</h3>
                    <h2>Rs. ${monthlyCharge.toLocaleString()}</h2>
                </div>
                <div class="summary-box cafe-box">
                    <h3>TOTAL CAFE REVENUE</h3>
                    <h2>Rs. ${monthlyCafe.toLocaleString()}</h2>
                </div>
                <div class="summary-box total-box">
                    <h3>TOTAL REVENUE</h3>
                    <h2>Rs. ${monthlyTotal.toLocaleString()}</h2>
                </div>
                <div class="summary-box due-box">
                    <h3>TOTAL DUE</h3>
                    <h2>Rs. ${monthlyDue.toLocaleString()}</h2>
                </div>
            </div>
            
            <h3>Daily Breakdown (${englishMonths[today.getMonth()]} ${today.getFullYear()})</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th><th>Charge Revenue</th><th>Cafe Revenue</th><th>Total Revenue</th><th>Due Amount</th>
                    </tr>
                </thead>
                <tbody>
      `;
      
      monthlyData.forEach(day => {
        html += `
                    <tr>
                        <td>${day.date}</td>
                        <td>Rs. ${parseFloat(day.charge).toLocaleString()}</td>
                        <td>Rs. ${parseFloat(day.cafe).toLocaleString()}</td>
                        <td>Rs. ${parseFloat(day.total).toLocaleString()}</td>
                        <td>Rs. ${parseFloat(day.due).toLocaleString()}</td>
                    </tr>
        `;
      });
      
      html += `
                </tbody>
            </table>
            
            <div class="footer">
                <p>Generated on: ${new Date().toLocaleString()}</p>
                <p><strong>SKIP THE GAS, SHOW THE CLASS</strong></p>
                <button class="print-btn" onclick="window.print()" style="padding:10px 20px;margin:20px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;">üñ®Ô∏è Print Report</button>
            </div>
        </body>
        </html>
      `;
      
      reportWindow.document.write(html);
      reportWindow.document.close();
      showNotification("Monthly report generated!");
      
    }).catch(error => {
      hideLoading();
      console.error("Error generating monthly report:", error);
      showNotification("Error generating monthly report", "danger");
    });
    
  } catch (error) {
    hideLoading();
    console.error("Error:", error);
    showNotification("Error generating monthly report", "danger");
  }
}

function generateCustomReport() {
  const startDate = prompt("Enter start date (YYYY-MM-DD):", currentDate);
  const endDate = prompt("Enter end date (YYYY-MM-DD):", currentDate);
  
  if (!startDate || !endDate) {
    showNotification("Date range required for custom report", "info");
    return;
  }
  
  showLoading("Generating Custom Report...");
  showNotification("Custom date range report coming soon!", "info");
  hideLoading();
}

function exportToCSV() {
  try {
    const rows = document.querySelectorAll("#logbook tbody tr");
    let csv = "S.N.,Time,Vehicle,% SOC,Diff,Amount,Cafe,Total,Paid,Status,Due\n";
    rows.forEach((row, index) => {
      const inputs = row.querySelectorAll("input");
      const select = row.querySelector("select");
      csv += `${index + 1},${inputs[0]?.value || ''},${inputs[1]?.value || ''},${inputs[2]?.value || ''},${inputs[3]?.value || ''},${inputs[4]?.value || ''},${inputs[5]?.value || ''},${inputs[6]?.value || ''},${inputs[7]?.value || ''},${select?.value || ''},${inputs[8]?.value || ''}\n`;
    });
    csv += `\nSUMMARY\n`;
    csv += `Charge Revenue,Rs.${document.getElementById("chargeTotal").textContent}\n`;
    csv += `Cafe Revenue,Rs.${document.getElementById("cafeTotal").textContent}\n`;
    csv += `Total Revenue,Rs.${document.getElementById("allTotal").textContent}\n`;
    csv += `Pending Due,Rs.${document.getElementById("dueTotal").textContent}\n`;
    
    const now = new Date();
    const filename = `charging_report_${now.getFullYear()}_${String(now.getMonth()+1).padStart(2,'0')}_${String(now.getDate()).padStart(2,'0')}.csv`;
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    showNotification("CSV exported successfully!");
  } catch {
    showNotification("Error exporting CSV!", "danger");
  }
}

async function exportToPDF() {
  showLoading("Generating PDF...");
  
  try {
    // Create a temporary div for PDF generation
    const printContent = document.createElement('div');
    printContent.style.cssText = 'position:absolute;left:-9999px;top:-9999px;width:800px;background:white;padding:20px;';
    
    // Clone the main content
    const container = document.querySelector('.container').cloneNode(true);
    
    // Remove no-print elements
    const noPrintElements = container.querySelectorAll('.no-print');
    noPrintElements.forEach(el => el.remove());
    
    // Add PDF-specific styling
    container.style.cssText = 'width:100%;max-width:none;margin:0;padding:0;background:white;color:black;font-family:Arial,sans-serif;';
    
    // Style the summary cards for PDF
    const summaryCards = container.querySelectorAll('.summary-card');
    summaryCards.forEach(card => {
      card.style.cssText = 'display:inline-block;width:180px;margin:5px;padding:10px;border:1px solid #000;text-align:center;background:white;';
      const before = card.querySelector('.summary-card::before');
      if (before) before.style.display = 'none';
    });
    
    // Style the table for PDF
    const table = container.querySelector('table');
    if (table) {
      table.style.cssText = 'width:100%;border-collapse:collapse;font-size:9pt;';
      const ths = table.querySelectorAll('th');
      ths.forEach(th => {
        th.style.cssText = 'background:#333;color:white;padding:5px;border:1px solid #000;text-align:center;';
      });
      const tds = table.querySelectorAll('td');
      tds.forEach(td => {
        td.style.cssText = 'padding:4px;border:1px solid #000;text-align:center;';
      });
    }
    
    printContent.appendChild(container);
    document.body.appendChild(printContent);
    
    // Use html2canvas to capture the content
    const canvas = await html2canvas(printContent, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff'
    });
    
    // Remove temporary div
    document.body.removeChild(printContent);
    
    // Create PDF
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 190;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
    
    // Add header
    pdf.setFontSize(18);
    pdf.setTextColor(0, 0, 0);
    pdf.text('Ivan Charging Station Report', 105, 10, { align: 'center' });
    
    // Add date
    pdf.setFontSize(11);
    pdf.text(`Date: ${document.getElementById("englishDateDisplay").textContent}`, 10, 20);
    pdf.text(`Generated: ${new Date().toLocaleString()}`, 10, 25);
    
    // Add summary at the end
    const summaryY = imgHeight + 20;
    pdf.setFontSize(14);
    pdf.text('SUMMARY', 105, summaryY, { align: 'center' });
    
    pdf.setFontSize(12);
    pdf.text(`Charge Revenue: Rs. ${document.getElementById("chargeTotal").textContent}`, 20, summaryY + 10);
    pdf.text(`Cafe Revenue: Rs. ${document.getElementById("cafeTotal").textContent}`, 20, summaryY + 17);
    pdf.text(`Total Revenue: Rs. ${document.getElementById("allTotal").textContent}`, 20, summaryY + 24);
    pdf.text(`Due Amount: Rs. ${document.getElementById("dueTotal").textContent}`, 20, summaryY + 31);
    
    // Save PDF
    const filename = `charging_report_${new Date().getFullYear()}_${String(new Date().getMonth()+1).padStart(2,'0')}_${String(new Date().getDate()).padStart(2,'0')}.pdf`;
    pdf.save(filename);
    
    hideLoading();
    showNotification("PDF exported successfully!");
    
  } catch (error) {
    hideLoading();
    console.error("Error generating PDF:", error);
    showNotification("Error generating PDF. Please try Print instead.", "danger");
  }
}

// Report Modal Control
function openReportModal() {
  document.getElementById('reportModal').style.display = 'flex';
}

function closeReportModal() {
  document.getElementById('reportModal').style.display = 'none';
}

// Data Table Functions
function shouldShowBlank(value) {
  if (value === "" || value === "0" || value === "0-") return true;
  try {
    return eval(value) === 0;
  } catch {
    return false;
  }
}

function hasBlankRowsBelow(currentRow) {
  const rows = document.querySelectorAll("#logbook tbody tr");
  const currentIndex = Array.from(rows).indexOf(currentRow);
  for (let i = currentIndex + 1; i < rows.length; i++) {
    const rowInputs = rows[i].querySelectorAll("input");
    const vehicle = rowInputs[1]?.value.trim();
    const amount = rowInputs[4]?.value.trim();
    const total = rowInputs[6]?.value.trim();
    const paid = rowInputs[7]?.value.trim();
    if (!vehicle && !amount && !total && !paid) return true;
  }
  return false;
}

function isRowAboveLocked(row) {
  const prevRow = row.previousElementSibling;
  return prevRow && prevRow.classList.contains("locked-row");
}

function isRowBlank(row) {
  const inputs = row.querySelectorAll("input");
  const select = row.querySelector("select");
  const vehicle = inputs[1]?.value.trim();
  const amount = inputs[4]?.value.trim();
  const total = inputs[6]?.value.trim();
  const paid = inputs[7]?.value.trim();
  const status = select?.value;
  return !vehicle && !amount && !total && !paid && !status;
}

function deleteRow(row) {
  if (isRowAboveLocked(row)) {
    alert("Cannot delete row! The row above is locked (Paid status).");
    return;
  }
  if (!isRowBlank(row)) {
    if (!confirm("Are you sure you want to delete this row? Data will be lost.")) return;
  }
  row.remove();
  updateSerialNumbers();
  updateTotals();
  autoSave();
  showNotification("Row deleted!");
}

function updateSerialNumbers() {
  document.querySelectorAll("#logbook tbody tr").forEach((row, index) => {
    row.querySelector("td:first-child").textContent = index + 1;
  });
}

function moveToNextCell(currentInput, row) {
  const inputs = Array.from(row.querySelectorAll("input:not([readonly])")).filter(i => !i.classList.contains('time-input') && !i.classList.contains('diff-input'));
  const select = row.querySelector("select");
  const allElements = [...inputs, select];
  const currentIndex = allElements.indexOf(currentInput);
  if (currentIndex < allElements.length - 1) {
    allElements[currentIndex + 1].focus();
  } else if (!hasBlankRowsBelow(row)) {
    const newRow = addRow();
    const vehicleInput = newRow.querySelector(".vehicle-input");
    if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
  }
}

function checkAndAddNewRowIfNeeded(row) {
  if (hasBlankRowsBelow(row)) return;
  const newRow = addRow();
  const vehicleInput = newRow.querySelector(".vehicle-input");
  if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
}

function lockRow(row) {
  const inputs = row.querySelectorAll("input:not(.time-input)");
  const select = row.querySelector("select");
  inputs.forEach(input => {
    input.setAttribute("readonly", "true");
  });
  select.setAttribute("disabled", "true");
  row.classList.add("locked-row");
  autoSave();
}

function unlockRow(row) {
  const inputs = row.querySelectorAll("input:not(.time-input)");
  const select = row.querySelector("select");
  inputs.forEach(input => {
    input.removeAttribute("readonly");
  });
  select.removeAttribute("disabled");
  row.classList.remove("locked-row");
  autoSave();
}

function updateStatusColor(select) {
  select.classList.remove("status-paid", "status-due");
  if (select.value === "paid") select.classList.add("status-paid");
  else if (select.value === "due") select.classList.add("status-due");
}

function calculateSOCDiff(socValue) {
  if (!socValue || !socValue.includes('-')) return '';
  const parts = socValue.split('-');
  if (parts.length === 2 && parts[0] && parts[1]) {
    const before = parseInt(parts[0]);
    const afterMatch = parts[1].match(/\d+/);
    if (afterMatch) {
      const after = parseInt(afterMatch[0]);
      if (!isNaN(before) && !isNaN(after) && after > before) {
        return (after - before).toString();
      }
    }
  }
  return '';
}

function formatSOCInput(value) {
  let x = value.replace(/[^a-zA-Z0-9\-]/g, '');
  if (x.length > 2 && !x.includes('-')) {
    return x.substring(0, 2) + '-' + x.substring(2, 5).toUpperCase();
  } else if (x.length === 2 && !x.endsWith('-') && !x.includes('-')) {
    return x + '-';
  }
  return x;
}

// COMPLETE addRow FUNCTION
function addRow(data = {}) {
  const tbody = document.querySelector("#logbook tbody");
  const row = document.createElement("tr");
  row.className = "fade-in";
  
  // S.N.
  const sn = document.createElement("td");
  sn.textContent = tbody.children.length + 1;
  
  // Time
  const time = document.createElement("td");
  const timeInput = document.createElement("input");
  timeInput.value = data.time || new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: true});
  timeInput.readOnly = true;
  timeInput.className = "time-input";
  time.appendChild(timeInput);
  
  // Vehicle
  const vehicle = document.createElement("td");
  const vehicleInput = document.createElement("input");
  vehicleInput.value = data.vehicle || "";
  vehicleInput.className = "vehicle-input";
  vehicleInput.addEventListener("input", function() {
    this.value = this.value.toUpperCase();
  });
  vehicleInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(vehicleInput, row);
  });
  vehicle.appendChild(vehicleInput);
  
  // % SOC
  const soc = document.createElement("td");
  const socContainer = document.createElement("div");
  socContainer.className = "soc-container";
  const socInput = document.createElement("input");
  socInput.className = "soc-input";
  socInput.value = data.percent || "";
  socInput.addEventListener("input", function() {
    const cursorPos = this.selectionStart;
    this.value = formatSOCInput(this.value);
    let newCursorPos = cursorPos;
    if (cursorPos === 2 && this.value.length > 2 && this.value.charAt(2) === '-') {
      newCursorPos = 3;
    }
    this.setSelectionRange(newCursorPos, newCursorPos);
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateDiffColumn(this);
  });
  socInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(socInput, row);
    if (e.key === "Backspace") {
      const cursorPos = this.selectionStart;
      const value = this.value;
      if (cursorPos === 3 && value.charAt(2) === '-') {
        this.value = value.substring(0, 2) + value.substring(3);
        this.setSelectionRange(2, 2);
        e.preventDefault();
        updateDiffColumn(this);
      }
    }
  });
  socInput.addEventListener("blur", function() {
    const parts = this.value.split('-');
    if (parts[0]) {
      let num = parseInt(parts[0]);
      if (num > 100) this.value = "100" + (parts[1] ? '-' + parts[1] : '');
    }
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
    updateDiffColumn(this);
  });
  shouldShowBlank(socInput.value) ? socInput.classList.add('empty-value') : socInput.classList.remove('empty-value');
  socContainer.appendChild(socInput);
  soc.appendChild(socContainer);
  
  // Diff column
  const diff = document.createElement("td");
  const diffInput = document.createElement("input");
  diffInput.value = calculateSOCDiff(socInput.value) || "";
  diffInput.readOnly = true;
  diffInput.className = "diff-input";
  shouldShowBlank(diffInput.value) ? diffInput.classList.add('empty-value') : diffInput.classList.remove('empty-value');
  diff.appendChild(diffInput);
  
  // Amount
  const amount = document.createElement("td");
  const amountInput = document.createElement("input");
  amountInput.value = data.amount || "";
  amountInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
  });
  amountInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(amountInput, row);
  });
  shouldShowBlank(amountInput.value) ? amountInput.classList.add('empty-value') : amountInput.classList.remove('empty-value');
  amount.appendChild(amountInput);
  
  // Cafe
  const cafe = document.createElement("td");
  const cafeInput = document.createElement("input");
  cafeInput.value = data.cafe || "";
  cafeInput.readOnly = true;
  shouldShowBlank(cafeInput.value) ? cafeInput.classList.add('empty-value') : cafeInput.classList.remove('empty-value');
  cafe.appendChild(cafeInput);
  
  // Total
  const total = document.createElement("td");
  const totalInput = document.createElement("input");
  totalInput.value = data.total || "";
  totalInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
  });
  totalInput.addEventListener("keydown", e => {
    if (e.key === "Enter") moveToNextCell(totalInput, row);
  });
  shouldShowBlank(totalInput.value) ? totalInput.classList.add('empty-value') : totalInput.classList.remove('empty-value');
  total.appendChild(totalInput);
  
  // Paid
  const paid = document.createElement("td");
  const paidInput = document.createElement("input");
  paidInput.value = data.paid || "";
  paidInput.addEventListener("input", function() {
    this.value = this.value.replace(/[^\d\+\-\*\/\.]/g, '');
    shouldShowBlank(this.value) ? this.classList.add('empty-value') : this.classList.remove('empty-value');
  });
  paidInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      if (!hasBlankRowsBelow(row)) {
        const newRow = addRow();
        const vehicleInput = newRow.querySelector(".vehicle-input");
        if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
      }
    }
  });
  shouldShowBlank(paidInput.value) ? paidInput.classList.add('empty-value') : paidInput.classList.remove('empty-value');
  paid.appendChild(paidInput);
  
  // Status
  const status = document.createElement("td");
  const statusSelect = document.createElement("select");
  statusSelect.className = "status-select";
  const statusOptions = [
    {value: "", text: "--Select--"},
    {value: "paid", text: "Paid", className: "status-paid"},
    {value: "due", text: "Due", className: "status-due"}
  ];
  statusOptions.forEach(option => {
    const opt = document.createElement("option");
    opt.value = option.value;
    opt.textContent = option.text;
    if (option.className) opt.className = option.className;
    statusSelect.appendChild(opt);
  });
  if (data.status) statusSelect.value = data.status;
  updateStatusColor(statusSelect);
  if (statusSelect.value === "paid" || statusSelect.value === "due") {
    statusSelect.style.backgroundImage = "none";
  }
  statusSelect.addEventListener("change", function() {
    updateStatusColor(this);
    if (this.value === "paid" || this.value === "due") {
      this.style.backgroundImage = "none";
      if (!hasBlankRowsBelow(row)) {
        const newRow = addRow();
        const vehicleInput = newRow.querySelector(".vehicle-input");
        if (vehicleInput) setTimeout(() => vehicleInput.focus(), 50);
      }
    } else {
      this.style.backgroundImage = "url(\"data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e\")";
    }
    autoSave();
    if (this.value === "paid") {
      if (!paidInput.value || paidInput.value === "0") {
        paidInput.value = totalInput.value;
      }
      paidInput.dispatchEvent(new Event('input'));
      lockRow(row);
    } else if (this.value === "due") {
      unlockRow(row);
    }
  });
  status.appendChild(statusSelect);
  
  // Due
  const due = document.createElement("td");
  const dueInput = document.createElement("input");
  dueInput.value = data.due || "";
  dueInput.readOnly = true;
  dueInput.className = "due-input";
  shouldShowBlank(dueInput.value) ? dueInput.classList.add('empty-value') : dueInput.classList.remove('empty-value');
  due.appendChild(dueInput);
  
  // Action
  const action = document.createElement("td");
  action.className = "action-cell";
  const deleteBtn = document.createElement("button");
  deleteBtn.className = "delete-btn";
  deleteBtn.innerHTML = "üóëÔ∏è";
  deleteBtn.title = "Delete Row";
  deleteBtn.addEventListener("click", () => deleteRow(row));
  action.appendChild(deleteBtn);
  
  // Double-click to unlock
  row.addEventListener("dblclick", function() {
    if (this.classList.contains("locked-row")) {
      unlockRow(this);
    }
  });
  
  // Update calculations function
  function updateCalculations() {
    const amountVal = evaluateValue(amountInput.value);
    const totalVal = evaluateValue(totalInput.value);
    const paidVal = evaluateValue(paidInput.value);
    const dueVal = totalVal - paidVal;
    
    const cafeVal = Math.max(0, totalVal - amountVal);
    cafeInput.value = cafeVal || "";
    
    const dueAmount = Math.max(0, dueVal);
    dueInput.value = dueAmount || "";
    dueInput.className = "due-input";
    
    if (dueVal > 0) {
      row.classList.add("due-row");
      dueInput.classList.remove('empty-value');
    } else {
      row.classList.remove("due-row");
      dueInput.classList.remove('empty-value');
      shouldShowBlank(dueInput.value) ? dueInput.classList.add('empty-value') : dueInput.classList.remove('empty-value');
    }
    
    shouldShowBlank(cafeInput.value) ? cafeInput.classList.add('empty-value') : cafeInput.classList.remove('empty-value');
    
    if (totalVal > 0) {
      if (paidVal >= totalVal) {
        statusSelect.value = "paid";
        updateStatusColor(statusSelect);
        statusSelect.style.backgroundImage = "none";
        row.classList.remove("due-row");
        lockRow(row);
      } else {
        statusSelect.value = "due";
        updateStatusColor(statusSelect);
        statusSelect.style.backgroundImage = "none";
      }
    }
    
    updateTotals();
    autoSave();
  }
  
  // Update Diff column function
  function updateDiffColumn(socInputElement) {
    const diffValue = calculateSOCDiff(socInputElement.value);
    diffInput.value = diffValue || "";
    if (diffValue) {
      diffInput.classList.remove('empty-value');
    } else {
      diffInput.classList.add('empty-value');
    }
  }
  
  // Event listeners for calculations
  [amountInput, totalInput, paidInput].forEach(input => {
    input.addEventListener("input", updateCalculations);
  });
  
  // Append all cells to row
  row.append(sn, time, vehicle, soc, diff, amount, cafe, total, paid, status, due, action);
  tbody.appendChild(row);
  
  // Focus on vehicle input if no data
  if (!data.vehicle) {
    setTimeout(() => vehicleInput.focus(), 50);
  }
  
  // Initial calculations
  updateCalculations();
  autoSave();
  
  // Scroll to bottom
  tbody.parentElement.scrollTop = tbody.parentElement.scrollHeight;
  
  // Lock row if status is paid
  if (data.status === "paid") {
    lockRow(row);
    statusSelect.style.backgroundImage = "none";
  }
  
  // Add due-row class if saved data has due amount
  if (data.due && parseFloat(data.due) > 0) {
    row.classList.add("due-row");
  }
  
  return row;
}

// Data Management Functions
function getDataForSave() {
  const rows = document.querySelectorAll("#logbook tbody tr");
  const data = Array.from(rows).map(row => {
    const inputs = row.querySelectorAll("input");
    const select = row.querySelector("select");
    return {
      time: inputs[0]?.value || '',
      vehicle: inputs[1]?.value || '',
      percent: inputs[2]?.value || '',
      diff: inputs[3]?.value || '',
      amount: inputs[4]?.value || '',
      cafe: inputs[5]?.value || '',
      total: inputs[6]?.value || '',
      paid: inputs[7]?.value || '',
      status: select?.value || '',
      due: inputs[8]?.value || ''
    };
  });
  return data;
}

function updateTotals() {
  let charge = 0, cafe = 0, all = 0, due = 0;
  document.querySelectorAll("#logbook tbody tr").forEach(row => {
    const inputs = row.querySelectorAll("input");
    charge += evaluateValue(inputs[4]?.value || 0);
    const total = evaluateValue(inputs[6]?.value || 0);
    cafe += (total - evaluateValue(inputs[4]?.value || 0));
    all += total;
    due += evaluateValue(inputs[8]?.value || 0);
  });
  
  document.getElementById("chargeTotal").textContent = charge.toLocaleString();
  document.getElementById("cafeTotal").textContent = cafe.toLocaleString();
  document.getElementById("allTotal").textContent = all.toLocaleString();
  document.getElementById("dueTotal").textContent = due.toLocaleString();
}

// SILENT Firebase Functions - No UI indicators
async function saveToFirebase() {
  if (!db) {
    // Silent failure - just return false
    return false;
  }

  try {
    const data = getDataForSave();
    const summary = {
      charge: document.getElementById("chargeTotal").textContent,
      cafe: document.getElementById("cafeTotal").textContent,
      total: document.getElementById("allTotal").textContent,
      due: document.getElementById("dueTotal").textContent,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      lastUpdated: new Date().toISOString()
    };

    await db.collection("logbook").doc(currentDate).set({
      entries: data,
      summary: summary,
      date: currentDate,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // Success - but don't show any notification
    return true;
  } catch (error) {
    console.error("Error saving to Firebase:", error);
    // Silent error - don't show notification
    return false;
  }
}

async function loadFromFirebase(date = currentDate) {
  if (!db) {
    // Silent failure - just load from local storage
    loadFromLocalStorage();
    return;
  }

  try {
    const docRef = db.collection("logbook").doc(date);
    const doc = await docRef.get();
    
    if (doc.exists) {
      const data = doc.data();
      const entries = data.entries || [];
      
      document.querySelector("#logbook tbody").innerHTML = "";
      
      if (entries.length > 0) {
        entries.forEach(row => addRow(row));
      } else {
        addRow();
      }
      
      updateTotals();
      // Don't show notification for silent load
    } else {
      // No data found, start fresh without notification
      if (document.querySelectorAll("#logbook tbody tr").length === 0) {
        addRow();
      }
    }
  } catch (error) {
    console.error("Error loading from Firebase:", error);
    // Silent fallback to local storage
    loadFromLocalStorage();
  }
}

function loadFromLocalStorage() {
  const data = localStorage.getItem("logbookData");
  if (data) {
    try {
      const entries = JSON.parse(data);
      document.querySelector("#logbook tbody").innerHTML = "";
      if (entries.length > 0) {
        entries.forEach(row => addRow(row));
      } else {
        addRow();
      }
      updateTotals();
      // Don't show notification for local load
    } catch (error) {
      console.error("Error loading from local storage:", error);
      addRow();
    }
  } else {
    addRow();
  }
}

// Modified autoSave to use Firebase silently
let staticSaveCounter = 0;
function autoSave() {
  const data = getDataForSave();
  
  // Always save to local storage (visible indicator)
  localStorage.setItem("logbookData", JSON.stringify(data));
  localStorage.setItem(`logbook_${currentDate}`, JSON.stringify(data));
  
  // Show local save indicator
  const indicator = document.getElementById("saveIndicator");
  indicator.classList.add("visible");
  setTimeout(() => indicator.classList.remove("visible"), 2000);
  
  // Silent Firebase save (every 5th auto-save or when explicitly triggered)
  staticSaveCounter = (staticSaveCounter || 0) + 1;
  if (staticSaveCounter % 5 === 0 && db) {
    // Fire and forget - don't await, don't show errors
    saveToFirebase().catch(error => {
      // Log error but don't show to user
      console.error("Silent auto-save to Firebase failed:", error);
    });
  }
}

// Initialize the application
window.onload = async function() {
  updateDateTime();
  setInterval(updateDateTime, 1000);
  
  // Silent Firebase connection test
  if (db) {
    try {
      // Silent test connection
      await db.collection("test").doc("test").get();
      isFirebaseConnected = true;
      // Don't show connection notification
    } catch (error) {
      console.log("Firebase test failed, using local storage:", error);
      isFirebaseConnected = false;
    }
  }
  
  // Load data silently
  if (isFirebaseConnected) {
    await loadFromFirebase();
  } else {
    loadFromLocalStorage();
  }
  
  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark-mode");
    document.getElementById("darkModeBtn").textContent = "‚òÄÔ∏è Light";
  }
  
  // Event Listeners
  document.getElementById("darkModeBtn").addEventListener("click", function() {
    document.body.classList.toggle("dark-mode");
    const isDark = document.body.classList.contains("dark-mode");
    this.textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
    localStorage.setItem("darkMode", isDark);
  });
  
  document.getElementById("printBtn").addEventListener("click", () => {
    window.print();
  });
  
  // Report Button - Now opens modal
  document.getElementById("reportBtn").addEventListener("click", openReportModal);
  
  // Report Modal Buttons
  document.getElementById("dailyReportBtn").addEventListener("click", function() {
    closeReportModal();
    generateDailyReport();
  });
  
  document.getElementById("weeklyReportBtn").addEventListener("click", function() {
    closeReportModal();
    generateWeeklyReport();
  });
  
  document.getElementById("monthlyReportBtn").addEventListener("click", function() {
    closeReportModal();
    generateMonthlyReport();
  });
  
  document.getElementById("customReportBtn").addEventListener("click", function() {
    closeReportModal();
    generateCustomReport();
  });
  
  document.getElementById("exportCSVBtn").addEventListener("click", function() {
    closeReportModal();
    exportToCSV();
  });
  
  document.getElementById("exportPDFBtn").addEventListener("click", function() {
    closeReportModal();
    exportToPDF();
  });
  
  document.getElementById("closeReportBtn").addEventListener("click", closeReportModal);
  
  // Close modal when clicking outside
  document.getElementById("reportModal").addEventListener("click", function(e) {
    if (e.target === this) {
      closeReportModal();
    }
  });
  
  // Sync button - now triggers silent save and shows notification
  document.getElementById("syncBtn").addEventListener("click", async function() {
    if (isFirebaseConnected) {
      showLoading("Syncing with Cloud...");
      try {
        const success = await saveToFirebase();
        hideLoading();
        if (success) {
          this.innerHTML = "‚úì Synced";
          setTimeout(() => this.innerHTML = "üîÑ Sync", 2000);
          showNotification("Data synced to Cloud successfully!");
        } else {
          showNotification("Failed to sync with Cloud", "danger");
        }
      } catch (error) {
        hideLoading();
        showNotification("Error syncing with Cloud", "danger");
      }
    } else {
      showNotification("Firebase not connected.", "danger");
    }
  });
  
  // Load from Cloud button - shows notification for explicit action
  document.getElementById("loadFromCloudBtn").addEventListener("click", async function() {
    if (isFirebaseConnected) {
      showLoading("Loading from Cloud...");
      await loadFromFirebase();
      hideLoading();
      showNotification("Data loaded from Cloud!");
    } else {
      showNotification("Firebase not connected.", "danger");
    }
  });
  
  // Clear All button
  document.getElementById("clearAllBtn").addEventListener("click", async function() {
    if (confirm("Clear ALL data for today? This will also clear from Cloud.")) {
      if (isFirebaseConnected && db) {
        try {
          // Silent delete from Firebase
          await db.collection("logbook").doc(currentDate).delete();
        } catch (error) {
          console.error("Error clearing from Firebase:", error);
        }
      }
      localStorage.removeItem("logbookData");
      document.querySelector("#logbook tbody").innerHTML = "";
      addRow();
      updateTotals();
      showNotification("All data cleared!");
    }
  });
  
  // Save All button - now triggers silent save and shows notification
  document.getElementById("saveAllBtn").addEventListener("click", async function() {
    if (isFirebaseConnected) {
      showLoading("Saving to Cloud...");
      try {
        const success = await saveToFirebase();
        hideLoading();
        if (success) {
          showNotification("Data saved to Cloud successfully!");
        } else {
          showNotification("Failed to save to Cloud", "danger");
        }
      } catch (error) {
        hideLoading();
        showNotification("Error saving to Cloud", "danger");
      }
    } else {
      autoSave();
      showNotification("Saved to local storage (Cloud not connected)", "info");
    }
  });
  
  // Set up silent auto-save interval
  setInterval(autoSave, 30000);
  updateTotals();
};

// Initialize with one row if empty
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    if (document.querySelectorAll("#logbook tbody tr").length === 0) {
      addRow();
    }
  });
}
</script>
</body>
</html>
